# AGENTS.md

Agent operating guide for `dungan24.github.io`.
This file is for agentic coding tools working inside this repository.

## 1) Project Snapshot

- Name: `dungan24.github.io`
- Runtime: Hugo static site (Blowfish theme)
- Purpose: render and publish briefing content generated by `../market-pulse`
- Data flow: `market-pulse` -> `dungan24.github.io` (content only)
- Key rendering layer:
  - Loader: `layouts/partials/extend-footer.html`
  - Post behavior: `static/js/briefing/*.js` + `static/js/market-pulse-enhancements.js`
  - Calendar core: `static/js/calendar/{parser,model,renderer}.js`
  - Calendar entrypoint adapter: `static/js/market-pulse-calendar.js`
  - Styles: `assets/css/custom.css` + `assets/css/custom/*.css`

Primary references:
- `CLAUDE.md`
- `README.md`
- `config/_default/hugo.toml`
- `config/_default/params.toml`
- `.github/workflows/hugo.yml`
- `.github/workflows/quality-gate.yml`
- `../market-pulse/specs/render-contract.md`
- `../market-pulse/specs/narrative-contract.md`
- `../market-pulse/specs/smoke-checklist.md`
- `../market-pulse/.aidocs/blog-workflow.md`
- `docs/agent-architecture-roadmap.md`

## 2) Source-of-Truth Commands

### Run local dev server

```bash
hugo server --port 1314 --bind 0.0.0.0 --navigateToChanged
```

### Windows helper script

```bash
serve.cmd
```

### Production build check

```bash
hugo --gc --minify
```

### Agent preflight / architecture checks

```bash
pwsh -File tools/agent-preflight.ps1
pwsh -File tools/agent-preflight.ps1 -RunBuild -FailOnFindings
pwsh -File tools/agent-preflight.ps1 -RunUiViewportSmoke -FailOnFindings
pwsh -File tools/agent-preflight.ps1 -RunCalendarSmoke -CalendarSmokeBaseUrl http://localhost:1314 -FailOnFindings
pwsh -File tools/calendar-smoke.ps1 -BaseUrl http://localhost:1314
pwsh -File tools/architecture-lint.ps1 -FailOnFindings
```

## 3) Code and Rendering Conventions

- Do not edit generated briefing posts in `content/posts/` unless explicitly requested
- Treat all slot posts (`pre-market-*`, `mid-day-*`, `post-market-*`) and `static/data/chart-data-*.json` as pipeline-managed outputs
- Keep markdown parsing rules backward-compatible with writer output
- `layouts/partials/extend-footer.html` is a conditional script loader grouped by page type:
  - always: `mp-config.js`, `ambient-orbs.js`, `theme-transition.js`, `reading-progress.js`, `branding-patch.js`, `footer-clock.js`
  - briefing post only (`isset .Params "slot"`): all `briefing/*.js`, `market-pulse-enhancements.js`, `market-charts-loader.js`, `render-charts.js`
  - calendar pipeline (briefing OR `/market-calendar/`): `calendar/parser.js`, `calendar/model.js`, `calendar/renderer.js`, `market-pulse-calendar.js`, `briefing/calendar-loader.js`
  - standalone calendar only (`RelPermalink "/market-calendar/"`): `standalone-calendar.js`
- ⚠️ `layouts/partials/footer.html` must call `partial "extend-footer.html" .` — NOT `partialCached`
  - `extend-footer.html` uses `.IsPage`, `.Params`, `.RelPermalink` and requires live page context
- Implement post behavior changes in `static/js/briefing/*.js`
- Implement calendar parsing/rendering changes in `static/js/calendar/*.js`
- Keep `static/js/market-pulse-calendar.js` as entrypoint/adapter only (no parser/model/renderer implementation)
- Keep visual updates in `assets/css/custom.css` and semantic split files under `assets/css/custom/`
- Prefer no inline `<script>/<style>` in `layouts/`; use external assets
- Allowed exception: `layouts/partials/extend-head-uncached.html` config bridge (`window.__MP_CONFIG`, conditional `window.__MP_PAGE`)
- Preserve mobile behavior across 640px, 768px, 1024px breakpoints

### XSS defense patterns (enforced from 2026-02-21)

- Use `MPBriefing.dom.escapeHtml()` for all external string values in `innerHTML` (headline, source, excerpt, href text)
- Use `MPBriefing.dom.sanitizeHref()` for all href values (blocks `javascript:` protocol)
- Both utilities are defined in `static/js/briefing/dom-utils.js` as `ns.escapeHtml` / `ns.sanitizeHref`
- Standalone IIFEs outside `MPBriefing` namespace (e.g. `market-pulse-enhancements.js`) declare local `escapeHtml` function
- `calendar/renderer.js` exposes `ns.escapeHtml` for reuse by `standalone-calendar.js`
- regime badge must set `badge.setAttribute("data-regime", r.current)` — CSS `[data-regime="RISK_ON"]` selector depends on this

### Contract-sensitive rendering rules (cross-repo)

- News cards:
  - Meta separator is `·`
  - `원문:` line is conditional
  - blockquote (`>`) excerpt is required by contract
- Calendar parsing:
  - `CALENDAR_LIST` should include `<!-- MP_KEY_EVENTS_START --> ... <!-- MP_KEY_EVENTS_END -->`
  - each event should be parseable via `<!-- MP_KEY_EVENT_START --> ... <!-- MP_KEY_EVENT_END -->`
- Block metadata v2:
  - support `MP_BLOCK_START { schema_version, block_id, priority, as_of_kst, ... }`
  - keep v1 fallback behavior
- Meta footer:
  - keep `<div class="mp-briefing-meta">` with generated time / slot / as-of time
- Front matter contract target includes `slot`, `generatedAt`, `asOfTime`, `regime`, `summary`
  - if upstream publisher is not yet fully aligned, blog-side fallback rendering must remain stable

## 4) Contribution Guardrails for Agents

- Read target files before editing
- Prefer minimal, surgical changes
- Do not reformat unrelated files
- Never change data semantics in this repo; only rendering/transformation behavior
- Run `pwsh -File tools/agent-audit.ps1` before and after large refactors
- Run `pwsh -File tools/architecture-lint.ps1 -FailOnFindings` before opening PR
- Use `.ignore` defaults for search; use `--no-ignore` only when intentionally scanning vendored/binary paths
- Treat `docs/screenshots/` as non-runtime archive; avoid using it as implementation source
- Keep runtime source files (`assets/`, `layouts/`, `static/js/`) below size thresholds where feasible
- Keep module granularity moderate:
  - prefer 1 entrypoint + feature modules
  - avoid splitting files below ~120 lines unless reused across 2+ features
  - if one feature change repeatedly touches 3+ modules, merge adjacent modules
  - do not split only for stylistic reasons; split only when ownership or change frequency justifies it

Validation checklist before finishing:
- Run `pwsh -File tools/agent-preflight.ps1 -RunBuild -FailOnFindings`
- Run `pwsh -File tools/agent-preflight.ps1 -RunUiViewportSmoke -FailOnFindings` (server required)
- Run `pwsh -File tools/calendar-smoke.ps1 -BaseUrl http://localhost:1314`
- Verify one recent post route manually (`/posts/pre-market-YYYY-MM-DD/` or slot equivalent)
- Confirm news cards (`.mp-news-card`) parse headline/meta/excerpt separately
- Confirm no duplicated translation/excerpt text in rendered cards

## 5) Repo-Specific Workflow Hints

- This repo does not generate facts; it only renders/publishes supplied content
- If rendering looks stale, first verify source markdown/json arrival times in `content/posts/` and `static/data/`
- If `market-pulse` pipeline path is wrong, set `BLOG_REPO_PATH` in `market-pulse` before debugging blog UI
- Treat contract changes as cross-repo changes; sync docs in both repositories in the same session

## 6) Git Workflow and CI Policy

**1인 운영 블로그 — main 직접 작업 허용**

- UI 개발, 콘텐츠 발행 모두 main에 직접 commit
- feature 브랜치 / PR 불필요 — 파이프라인 publish도 main push
- 대규모 리팩토링이나 실험적 작업에만 선택적으로 feature 브랜치 사용
- quality gate (`.github/workflows/quality-gate.yml`)는 PR 오픈 시에만 트리거됨
- main push는 hugo build + deploy (`hugo.yml`)만 실행

## 7) Maintenance

When changing operational behavior, update this file in the same commit:
- local run command/port
- Hugo build workflow
- markdown parsing rules in footer loader and loaded JS modules
- key style/UX constraints for `custom.css` and semantic split CSS files
- audit/preflight thresholds and inline-template policy
