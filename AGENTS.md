# AGENTS.md

Agent operating guide for `market-pulse-blog`.
This file is for agentic coding tools working inside this repository.

## 1) Project Snapshot

- Name: `market-pulse-blog`
- Runtime: Hugo static site (Blowfish theme)
- Purpose: render and publish briefing content generated by `../market-pulse`
- Data flow: `market-pulse` -> `market-pulse-blog` (content only)
- Key rendering layer:
  - Loader: `layouts/partials/extend-footer.html`
  - Post behavior: `static/js/briefing/*.js` + `static/js/market-pulse-enhancements.js`
  - Calendar core: `static/js/calendar/{parser,model,renderer}.js`
  - Calendar entrypoint adapter: `static/js/market-pulse-calendar.js`
  - Styles: `assets/css/custom.css` + `assets/css/custom/*.css`

Primary references:
- `CLAUDE.md`
- `README.md`
- `config/_default/hugo.toml`
- `config/_default/params.toml`
- `.github/workflows/hugo.yml`
- `.github/workflows/quality-gate.yml`
- `../market-pulse/specs/render-contract.md`
- `../market-pulse/specs/narrative-contract.md`
- `../market-pulse/specs/smoke-checklist.md`
- `../market-pulse/.aidocs/blog-workflow.md`
- `docs/agent-architecture-roadmap.md`

## 2) Source-of-Truth Commands

### Run local dev server

```bash
hugo server --port 1314 --bind 0.0.0.0 --navigateToChanged
```

### Windows helper script

```bash
serve.cmd
```

### Production build check

```bash
hugo --gc --minify
```

### Agent preflight / architecture checks

```bash
pwsh -File tools/agent-preflight.ps1
pwsh -File tools/agent-preflight.ps1 -RunBuild -FailOnFindings
pwsh -File tools/agent-preflight.ps1 -RunUiViewportSmoke -FailOnFindings
pwsh -File tools/agent-preflight.ps1 -RunCalendarSmoke -CalendarSmokeBaseUrl http://localhost:1314 -FailOnFindings
pwsh -File tools/calendar-smoke.ps1 -BaseUrl http://localhost:1314
pwsh -File tools/architecture-lint.ps1 -FailOnFindings
```

## 3) Code and Rendering Conventions

- Do not edit generated briefing posts in `content/posts/` unless explicitly requested
- Treat all slot posts (`pre-market-*`, `mid-day-*`, `post-market-*`) and `static/data/chart-data-*.json` as pipeline-managed outputs
- Keep markdown parsing rules backward-compatible with writer output
- Keep `layouts/partials/extend-footer.html` as a thin script loader only
- Implement post behavior changes in `static/js/briefing/*.js`
- Implement calendar parsing/rendering changes in `static/js/calendar/*.js`
- Keep `static/js/market-pulse-calendar.js` as entrypoint/adapter only (no parser/model/renderer implementation)
- Keep visual updates in `assets/css/custom.css` and semantic split files under `assets/css/custom/`
- Prefer no inline `<script>/<style>` in `layouts/`; use external assets
- Allowed exception: `layouts/partials/extend-head-uncached.html` config bridge (`window.__MP_CONFIG`, conditional `window.__MP_PAGE`)
- Preserve mobile behavior across 640px, 768px, 1024px breakpoints

### Contract-sensitive rendering rules (cross-repo)

- News cards:
  - Meta separator is `·`
  - `원문:` line is conditional
  - blockquote (`>`) excerpt is required by contract
- Calendar parsing:
  - `CALENDAR_LIST` should include `<!-- MP_KEY_EVENTS_START --> ... <!-- MP_KEY_EVENTS_END -->`
  - each event should be parseable via `<!-- MP_KEY_EVENT_START --> ... <!-- MP_KEY_EVENT_END -->`
- Block metadata v2:
  - support `MP_BLOCK_START { schema_version, block_id, priority, as_of_kst, ... }`
  - keep v1 fallback behavior
- Meta footer:
  - keep `<div class="mp-briefing-meta">` with generated time / slot / as-of time
- Front matter contract target includes `slot`, `generatedAt`, `asOfTime`, `regime`, `summary`
  - if upstream publisher is not yet fully aligned, blog-side fallback rendering must remain stable

## 4) Contribution Guardrails for Agents

- Read target files before editing
- Prefer minimal, surgical changes
- Do not reformat unrelated files
- Never change data semantics in this repo; only rendering/transformation behavior
- Run `pwsh -File tools/agent-audit.ps1` before and after large refactors
- Run `pwsh -File tools/architecture-lint.ps1 -FailOnFindings` before opening PR
- Use `.ignore` defaults for search; use `--no-ignore` only when intentionally scanning vendored/binary paths
- Treat `docs/screenshots/` as non-runtime archive; avoid using it as implementation source
- Keep runtime source files (`assets/`, `layouts/`, `static/js/`) below size thresholds where feasible
- Keep module granularity moderate:
  - prefer 1 entrypoint + feature modules
  - avoid splitting files below ~120 lines unless reused across 2+ features
  - if one feature change repeatedly touches 3+ modules, merge adjacent modules
  - do not split only for stylistic reasons; split only when ownership or change frequency justifies it

Validation checklist before finishing:
- Run `pwsh -File tools/agent-preflight.ps1 -RunBuild -FailOnFindings`
- Run `pwsh -File tools/agent-preflight.ps1 -RunUiViewportSmoke -FailOnFindings` (server required)
- Run `pwsh -File tools/calendar-smoke.ps1 -BaseUrl http://localhost:1314`
- Verify one recent post route manually (`/posts/pre-market-YYYY-MM-DD/` or slot equivalent)
- Confirm news cards (`.mp-news-card`) parse headline/meta/excerpt separately
- Confirm no duplicated translation/excerpt text in rendered cards

## 5) Repo-Specific Workflow Hints

- This repo does not generate facts; it only renders/publishes supplied content
- If rendering looks stale, first verify source markdown/json arrival times in `content/posts/` and `static/data/`
- If `market-pulse` pipeline path is wrong, set `BLOG_REPO_PATH` in `market-pulse` before debugging blog UI
- Treat contract changes as cross-repo changes; sync docs in both repositories in the same session

## 6) CI and PR Policy

- Architecture quality gate workflow: `.github/workflows/quality-gate.yml`
- PR checklist template: `.github/pull_request_template.md`
- CODEOWNERS enforced review set: `.github/CODEOWNERS`
- For architecture-sensitive changes, do not merge until quality gate is green

## 7) Maintenance

When changing operational behavior, update this file in the same PR:
- local run command/port
- Hugo build workflow
- markdown parsing rules in footer loader and loaded JS modules
- key style/UX constraints for `custom.css` and semantic split CSS files
- audit/preflight thresholds and inline-template policy
