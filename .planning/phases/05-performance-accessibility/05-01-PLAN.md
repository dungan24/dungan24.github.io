---
phase: 05-performance-accessibility
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/css/custom.css
  - assets/css/custom/calendar.css
  - assets/css/custom/layout-overrides.css
  - assets/css/custom/briefing-sections.css
  - assets/css/custom/toc-and-effects.css
autonomous: true
requirements:
  - PERF-01
  - PERF-02
  - PERF-03

must_haves:
  truths:
    - "Post 페이지에서 동시 활성 backdrop-filter 요소가 10개 이하다"
    - "Home 페이지에서 동시 활성 backdrop-filter 요소가 10개 이하다"
    - "내부 중첩 카드(.prose table, .mp-upcoming__content, .mp-regime-panel)는 backdrop-filter 없이 opaque rgba() 배경만 사용한다"
    - "최외곽 컨테이너(.briefing-section, .mp-calendar.mp-glass-card, #menu-blur 등)만 backdrop-filter를 갖는다"
    - "640px 이하 모바일에서 모든 모바일-visible 요소의 blur 값이 var(--mp-glass-blur)를 통해 자동 축소된다"
    - ".mp-post-hero backdrop-filter 선언이 하나의 파일에만 존재한다 (중복 제거)"
  artifacts:
    - path: "assets/css/custom.css"
      provides: ".prose table backdrop-filter 제거, opaque rgba 배경 적용"
      contains: "background: rgba(18, 18, 42, 0.75)"
    - path: "assets/css/custom/calendar.css"
      provides: ".mp-upcoming__content backdrop-filter 제거, opaque rgba 배경 적용"
      contains: "background: rgba(30, 41, 59, 0.6)"
    - path: "assets/css/custom/layout-overrides.css"
      provides: ".mp-regime-panel backdrop-filter 제거 + .search-modal-container var() 전환"
    - path: "assets/css/custom/briefing-sections.css"
      provides: ".mp-post-hero 중복 backdrop-filter 제거"
    - path: "assets/css/custom/toc-and-effects.css"
      provides: "prefers-reduced-motion 가드에 누락 요소 추가"
  key_links:
    - from: "assets/css/custom.css @media (max-width: 640px)"
      to: "모든 var(--mp-glass-blur) 소비 요소"
      via: "CSS custom property cascade"
      pattern: "var\\(--mp-glass-blur\\)"
    - from: "assets/css/custom/toc-and-effects.css @media (prefers-reduced-motion)"
      to: "모든 backdrop-filter 요소"
      via: "selector list in reduced-motion block"
      pattern: "backdrop-filter: none"
---

<objective>
backdrop-filter 중첩 위반 제거 + 모바일 blur 최적화 확인 + prefers-reduced-motion 가드 보완

Purpose: Phase 1-4에서 구축한 글래스 시스템의 GPU 성능 최적화. 중첩 backdrop-filter를 제거하여
뷰포트당 동시 활성 요소를 10개 이하로 유지하고, 모바일에서 blur 변수가 정상 cascade되도록 보장한다.

Output: 수정된 CSS 파일 5개, backdrop-filter 위반 0건, 모바일 blur cascade 검증 완료
</objective>

<execution_context>
@C:/Users/sc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-performance-accessibility/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: 중첩 backdrop-filter 위반 제거 (PERF-02)</name>
  <files>
    assets/css/custom.css
    assets/css/custom/calendar.css
    assets/css/custom/layout-overrides.css
    assets/css/custom/briefing-sections.css
  </files>
  <action>
**Research 05-RESEARCH.md의 Violation Analysis 표에 근거하여 3개 중첩 위반 + 1개 중복 선언을 수정한다.**

**1. `.prose table` (custom.css ~line 274) — HIGH 위반**
부모 `.briefing-section`이 이미 `backdrop-filter: var(--mp-glass-blur)`를 가지고 있으므로 자식 테이블의 backdrop-filter를 제거한다.
- `-webkit-backdrop-filter: blur(8px);` 라인 삭제
- `backdrop-filter: blur(8px);` 라인 삭제
- `background: rgba(18, 18, 42, 0.5)` → `rgba(18, 18, 42, 0.75)` (opacity 증가로 blur 제거 보상)
- 라이트 모드 `layout-overrides.css:411` `:root:not(.dark) .prose table` 블록은 이미 `background: var(--mp-glass-bg)`로 opaque → 변경 불필요

**2. `.mp-upcoming__content` (calendar.css ~line 384) — MEDIUM 위반**
부모 `.mp-calendar.mp-glass-card`가 이미 `backdrop-filter: var(--mp-glass-blur)`를 가지고 있으므로 자식의 backdrop-filter를 제거한다.
- `backdrop-filter: blur(4px);` 라인 삭제
- `background: rgba(30, 41, 59, 0.4)` → `rgba(30, 41, 59, 0.6)` (opacity 증가)
- 라이트 모드 `calendar.css:524` `:root:not(.dark) .mp-upcoming__content`는 `background: #FFFFFF` → 완전 opaque, 변경 불필요

**3. `.mp-regime-panel` (layout-overrides.css ~line 260-261) — MEDIUM 위반**
Hugo shortcode로 렌더되어 `.briefing-section` 내부에 삽입된다. 부모가 이미 backdrop-filter를 가지므로 자식의 backdrop-filter를 제거한다.
- `-webkit-backdrop-filter: var(--mp-glass-blur);` 라인 삭제
- `backdrop-filter: var(--mp-glass-blur);` 라인 삭제
- `background`에서 `var(--mp-glass-bg)` 부분의 opacity가 충분한지 확인. 현재 `linear-gradient(160deg, rgba(124,58,237,0.08), transparent 40%), var(--mp-glass-bg)` 구조이므로 --mp-glass-bg가 주 배경. dark mode default는 `rgba(18,18,42,0.65)` → backdrop-filter 없이도 충분히 opaque.

**4. `.mp-post-hero` 중복 선언 제거 (briefing-sections.css ~line 130-131)**
`post-hero.css:10`과 `briefing-sections.css:130` 모두 `.mp-post-hero`에 `backdrop-filter`를 선언한다.
동일 요소에 대한 중복이므로 `briefing-sections.css`에서 `backdrop-filter` 라인을 제거한다 (post-hero.css가 전용 파일).
- `briefing-sections.css`의 `.mp-post-hero` 블록에서 `-webkit-backdrop-filter: var(--mp-glass-blur);` 삭제
- `briefing-sections.css`의 `.mp-post-hero` 블록에서 `backdrop-filter: var(--mp-glass-blur);` 삭제

**주의사항:**
- 최외곽 컨테이너의 backdrop-filter는 절대 제거하지 않는다
- :root{} 변수 선언을 컴포넌트 파일에 추가하지 않는다
- @media prefers-color-scheme 사용하지 않는다 (.dark 클래스만 사용)
  </action>
  <verify>
다음 CSS grep으로 중첩 위반이 0건인지 확인:

```bash
# .prose table에 backdrop-filter가 없어야 함
rg "backdrop-filter" assets/css/custom.css | rg -v "^#|^/\*" | rg "\.prose table" && echo "FAIL: .prose table still has backdrop-filter" || echo "PASS"

# .mp-upcoming__content에 backdrop-filter가 없어야 함
rg "backdrop-filter" assets/css/custom/calendar.css | rg "upcoming__content" && echo "FAIL" || echo "PASS"

# .mp-regime-panel에 backdrop-filter가 없어야 함
rg "backdrop-filter" assets/css/custom/layout-overrides.css | rg "regime-panel" && echo "FAIL" || echo "PASS"

# briefing-sections.css에 .mp-post-hero backdrop-filter가 없어야 함
rg "backdrop-filter" assets/css/custom/briefing-sections.css | rg "post-hero" && echo "FAIL" || echo "PASS"
```

Hugo build 성공 확인:
```bash
hugo --gc --minify 2>&1 | tail -5
```
  </verify>
  <done>
4개 중첩/중복 backdrop-filter가 제거되고, 제거된 요소의 background opacity가 보상 증가되어 있다. Hugo build가 에러 없이 완료된다.
  </done>
</task>

<task type="auto">
  <name>Task 2: 모바일 blur 변수화 + prefers-reduced-motion 가드 보완 (PERF-01, PERF-03)</name>
  <files>
    assets/css/custom/layout-overrides.css
    assets/css/custom/toc-and-effects.css
  </files>
  <action>
**Part A — 모바일-visible 요소의 하드코딩된 blur를 var(--mp-glass-blur)로 전환 (PERF-03)**

research 05-RESEARCH.md의 Pattern 2에 근거하여, 모바일에서도 표시되지만 하드코딩된 blur 값을 쓰는 요소를 수정한다.

**1. `.search-modal-container` (layout-overrides.css ~line 207)**
- 현재: `backdrop-filter: blur(16px) !important;`
- 변경: `backdrop-filter: var(--mp-glass-blur) !important;`
- `-webkit-backdrop-filter`도 동일하게 변경 (있으면)
- `!important`는 유지 — Blowfish 테마 오버라이드에 필요

**수정하지 않는 요소 (데스크톱 전용):**
- `#TOCView` — 사이드바 TOC는 모바일에서 미표시 → 하드코딩 허용
- `#mp-mobile-bottom-nav` — blur(16px)은 고정 UI 요소로 mobile에서 항상 보임. 하지만 이 요소는 mobile bottom nav 자체이므로 blur 감소보다 시각적 일관성이 중요. 최종 판단: var(--mp-glass-blur)로 전환하여 640px 이하에서 blur(8px), 480px 이하에서 blur(4px) cascade를 따르게 한다.

**2. `#mp-mobile-bottom-nav` (layout-overrides.css ~line 164)**
- 현재: `backdrop-filter: blur(16px);`
- 변경: `-webkit-backdrop-filter: var(--mp-glass-blur); backdrop-filter: var(--mp-glass-blur);`
- 이 요소는 이미 `@media (max-width: 640px)` 안에 선언되어 있으므로 mobile media query 안에서 var()가 올바르게 cascade된다.

**3. `.mp-calendar__tooltip-shared` (calendar.css ~line 133) — 수정하지 않음**
- 이 요소는 hover시에만 표시되며 calendar.css는 이 Task의 files_modified에 포함되지 않음
- 터치 디바이스에서 hover tooltip은 실질적으로 미사용 → 하드코딩 허용

**Part B — prefers-reduced-motion 가드 보완 (PERF-01 간접 지원)**

`toc-and-effects.css:508-531`의 `@media (prefers-reduced-motion: reduce)` 블록에 누락된 backdrop-filter 요소를 추가한다.

현재 포함된 요소: `.briefing-section`, `.mp-ticker-group`, `.mp-briefing-card`, `.mp-news-card`, `.mp-post-hero`, `#TOCView`, `.market-chart-card`

추가할 요소 (research의 Coverage gap 섹션):
- `#menu-blur`
- `#single_header`
- `.mp-briefing-meta`
- `.mp-regime-panel`
- `.mp-calendar.mp-glass-card`
- `#mp-mobile-bottom-nav`
- `.search-modal-container`

기존 selector list에 위 7개를 추가한다. 기존 요소는 순서 유지하고 뒤에 append.
`.mp-upcoming__content`, `.mp-calendar__tooltip-shared`, `.prose table`은 Task 1에서 backdrop-filter를 이미 제거했으므로 가드에 추가할 필요 없다.

**주의사항:**
- toc-and-effects.css의 기존 `@media (prefers-reduced-motion)` 블록 구조를 유지
- 새 selector는 기존 list의 마지막 요소 뒤에 comma로 연결
- backdrop-filter: none; -webkit-backdrop-filter: none; 동일 패턴 사용
  </action>
  <verify>
prefers-reduced-motion 가드에 모든 backdrop-filter 요소가 포함되었는지 확인:

```bash
# reduced-motion 블록 내 셀렉터 수 확인 (14개 이상이어야 함 — 기존 7 + 추가 7)
rg -A 30 "prefers-reduced-motion: reduce" assets/css/custom/toc-and-effects.css
```

모바일-visible 요소가 var(--mp-glass-blur)를 사용하는지 확인:

```bash
# search-modal-container가 var(--mp-glass-blur) 사용
rg "search-modal-container" assets/css/custom/layout-overrides.css -A 5 | rg "glass-blur"

# mp-mobile-bottom-nav가 var(--mp-glass-blur) 사용
rg "mp-mobile-bottom-nav" assets/css/custom/layout-overrides.css -A 10 | rg "glass-blur"
```

Hugo build 성공:
```bash
hugo --gc --minify 2>&1 | tail -5
```
  </verify>
  <done>
모바일-visible 요소 2개(.search-modal-container, #mp-mobile-bottom-nav)가 var(--mp-glass-blur) cascade를 따른다. prefers-reduced-motion 가드가 모든 backdrop-filter 요소(14개 셀렉터)를 포함한다. Hugo build 성공.
  </done>
</task>

<task type="auto">
  <name>Task 3: 뷰포트당 backdrop-filter 카운트 최종 검증 (PERF-01)</name>
  <files></files>
  <action>
Task 1-2 수정 후 최종 backdrop-filter 인벤토리를 CSS grep으로 집계한다. 검증 전용 태스크 — 파일 수정 없음.

**Step 1: 전체 활성 backdrop-filter 규칙 카운트**

모든 CSS 파일에서 `backdrop-filter` 선언을 grep하되, 다음을 제외:
- `backdrop-filter: none` (리셋 규칙)
- `prefers-reduced-motion` 블록 내부
- 주석 처리된 라인

**Step 2: 페이지별 동시 활성 요소 추정**

Post 페이지 (최대 부하 시나리오, 다크 모드):
- `#menu-blur` (1)
- `#single_header` (1)
- `.mp-post-hero` (1) — post-hero.css만 담당
- `.briefing-section` (2: fact + opinion)
- `#TOCView` (1) — 데스크톱 전용
- `.mp-briefing-meta` (1)
- `.market-chart-card` (N) — 차트 있는 포스트만

예상 합계: 7 + 차트 수. 차트 2개 포함 시 9 → 10개 이하 OK.
`.prose table`, `.mp-regime-panel`에서 backdrop-filter 제거 완료이므로 이들은 카운트에서 빠진다.

Home 페이지 (다크 모드, 데스크톱):
- `#menu-blur` (1)
- `.mp-ticker-group` (4)
- `.mp-briefing-card` (N, 보통 4개 above fold)
- `.mp-calendar.mp-glass-card` (1)

예상 합계: 6 + 카드 수. 카드 4개 시 10 → 한계선이지만 10 이하 OK.

**Step 3: 카운트가 10을 초과하는 경우**
만약 post 페이지에서 `.market-chart-card` 3개 + 나머지 7개 = 10 초과 시,
차트 카드를 스크롤 기반 lazy activation으로 해결해야 하나 이는 JS 변경이 필요하므로
이 phase 범위를 넘어갈 수 있다. 해당 경우 STATE.md에 기록한다.

**결론:** grep 결과를 기반으로 "10개 이하" 판정을 문서화한다.
  </action>
  <verify>
```bash
# 활성 backdrop-filter 규칙 전체 카운트 (none 제외, 주석 제외)
rg "backdrop-filter:" assets/css/ --type css | rg -v "none" | rg -v "^.*//|^.*\*" | rg -v "RESEARCH|PLAN"

# Post 페이지 관련 파일만 카운트
echo "--- Post page active elements ---"
rg "backdrop-filter:" assets/css/custom.css assets/css/custom/post-hero.css assets/css/custom/toc-and-effects.css assets/css/custom/layout-overrides.css assets/css/custom/chart-cards.css --type css | rg -v "none" | rg -v "prefers-reduced-motion" | rg -v "^.*\*"
```
  </verify>
  <done>
CSS grep 기반 인벤토리에서 Post 페이지 동시 활성 backdrop-filter 요소가 10개 이하, Home 페이지도 10개 이하임이 확인된다. 모든 중첩 위반이 Task 1에서 제거되어 PERF-01/PERF-02 동시 충족.
  </done>
</task>

</tasks>

<verification>
**Phase 전체 검증 (모든 Task 완료 후):**

1. PERF-01 — 뷰포트당 활성 backdrop-filter ≤10:
   - Post 페이지: grep 카운트 + DOM 구조 분석으로 동시 활성 요소 10개 이하 확인
   - Home 페이지: 동일 방법으로 10개 이하 확인

2. PERF-02 — 내부 카드 opaque, 최외곽만 backdrop-filter:
   - `.prose table` → backdrop-filter 없음, background opacity ≥ 0.75
   - `.mp-upcoming__content` → backdrop-filter 없음, background opacity ≥ 0.6
   - `.mp-regime-panel` → backdrop-filter 없음, background는 gradient + glass-bg
   - `.mp-news-card` → Phase 4에서 이미 제거 확인됨

3. PERF-03 — 모바일 blur 자동 축소:
   - `var(--mp-glass-blur)` 사용하는 모든 모바일-visible 요소가 640px 이하에서 blur(8px) cascade
   - `.search-modal-container`, `#mp-mobile-bottom-nav` → var(--mp-glass-blur) 사용 확인

4. Hugo build 성공:
   ```bash
   hugo --gc --minify
   ```
</verification>

<success_criteria>
- backdrop-filter 중첩 위반 0건 (내부 카드에 backdrop-filter 선언 없음)
- Post 페이지 동시 활성 backdrop-filter ≤ 10
- Home 페이지 동시 활성 backdrop-filter ≤ 10
- 모바일-visible 요소가 모두 var(--mp-glass-blur)를 통해 mobile blur cascade에 참여
- prefers-reduced-motion 가드가 모든 backdrop-filter 요소를 포함
- .mp-post-hero 중복 선언 제거 (1개 파일에만 존재)
- Hugo build 에러 없음
</success_criteria>

<output>
After completion, create `.planning/phases/05-performance-accessibility/05-01-SUMMARY.md`
</output>
