---
phase: 03-background-regime
plan: 02
type: execute
wave: 2
depends_on:
  - "03-01"
files_modified:
  - assets/css/custom/ambient-orbs.css
  - static/js/ambient-orbs.js
  - static/js/home-market-overview.js
autonomous: true
requirements:
  - RGME-01
  - RGME-02

must_haves:
  truths:
    - "홈 페이지의 글래스 카드(.briefing-section, .mp-ticker-group) 배경에 현재 regime(bull/bear/neutral)에 따른 미묘한 색조 틴팅이 보인다"
    - "Bull(RISK_ON) regime일 때 카드에 빨간 기운이, Bear(RISK_OFF/PANIC)일 때 파란 기운이, Neutral(CAUTIOUS)일 때 보라 기운이 인지된다"
    - "다크 모드에서 틴팅이 약간 더 진하고(0.06), 라이트 모드에서 더 연하다(0.03)"
    - "regime 데이터가 로드되기 전에는 틴팅이 표시되지 않아 기본 violet flash가 발생하지 않는다"
  artifacts:
    - path: "assets/css/custom/ambient-orbs.css"
      provides: "Regime tinting overlay CSS rules (.regime-loaded conditional)"
      contains: "regime-loaded"
    - path: "static/js/ambient-orbs.js"
      provides: "KR_ORB_RGB mapping, regime detection, .regime-loaded class toggle, orb color update"
      contains: "KR_ORB_RGB"
    - path: "static/js/home-market-overview.js"
      provides: "window.MP_REGIME_CURRENT setter + mp:regime-ready CustomEvent dispatch"
      contains: "MP_REGIME_CURRENT"
  key_links:
    - from: "static/js/home-market-overview.js"
      to: "window.MP_REGIME_CURRENT"
      via: "sets global in render() after chart-data fetch"
      pattern: "MP_REGIME_CURRENT"
    - from: "static/js/ambient-orbs.js"
      to: "window.MP_REGIME_CURRENT"
      via: "reads regime string directly from global (no hex reverse-lookup)"
      pattern: "MP_REGIME_CURRENT"
    - from: "static/js/ambient-orbs.js"
      to: "document.documentElement.classList"
      via: "adds .regime-loaded class after KR color injection"
      pattern: "regime-loaded"
    - from: "assets/css/custom/ambient-orbs.css"
      to: "--regime-color-rgb CSS variable"
      via: "rgba(var(--regime-color-rgb) / N) in ::after pseudo-element"
      pattern: "regime-color-rgb"
---

<objective>
Regime 상태(Bull/Bear/Neutral)에 따라 글래스 카드 배경에 미묘한 색조 틴팅을 적용한다. 한국 시장 컨벤션(상승=빨강, 하락=파랑)을 따르는 별도 색상 매핑으로 orb 색상도 regime에 연동한다.

Purpose: 사용자가 페이지를 열었을 때 "오늘 불장이네" / "오늘 약장이네" 느낌이 카드 색감에서 직관적으로 전달되어야 한다. 이것은 단순 데코레이션이 아니라 정보 전달 수단이다.
Output: `ambient-orbs.css`에 regime tinting CSS 추가, `ambient-orbs.js`에 regime 감지 + 색상 주입 로직 추가, `home-market-overview.js`에 `window.MP_REGIME_CURRENT` setter + `mp:regime-ready` event dispatch 추가
</objective>

<execution_context>
@C:/Users/sc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-regime/03-RESEARCH.md
@.planning/phases/03-background-regime/03-01-SUMMARY.md

Key reference files:
@assets/css/custom/ambient-orbs.css — Plan 01에서 생성한 orb CSS (여기에 tinting 규칙 추가)
@static/js/ambient-orbs.js — Plan 01에서 생성한 orb JS (여기에 regime 로직 추가)
@static/js/mp-config.js — MP_CONFIG.colors.regime_rgb 매핑 확인
@static/js/home-market-overview.js — 홈 페이지 regime fetch 패턴 참고
@static/js/briefing/regime-hero.js — 포스트 페이지 regime 주입 패턴 참고
@assets/css/custom.css — --regime-color-rgb 변수, .briefing-section 스타일 확인
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add regime tinting CSS rules to ambient-orbs.css</name>
  <files>assets/css/custom/ambient-orbs.css</files>
  <action>
Plan 01에서 생성한 `ambient-orbs.css` 파일 끝에 regime tinting 규칙을 추가한다.

**Regime 틴팅 오버레이 (`.regime-loaded` 조건부):**

Research의 Pitfall 3 대응: JS가 `--regime-color-rgb` 변수를 설정하고 `.regime-loaded` 클래스를 `<html>`에 추가한 후에만 틴팅이 활성화된다. 이것으로 기본 violet flash를 방지한다.

```css
/* ── Regime Tinting ── */

/* 틴팅 대상: .briefing-section과 .mp-ticker-group의 ::after pseudo-element */
/* .briefing-section::before는 이미 data-label 배지에 사용 중 — ::after만 사용 */
/* .mp-ticker-group::after는 비어있으므로 자유 사용 */

.regime-loaded .briefing-section,
.regime-loaded .mp-ticker-group {
  position: relative;  /* ::after positioning context */
}

.regime-loaded .briefing-section::after,
.regime-loaded .mp-ticker-group::after {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: inherit;
  background: rgba(var(--regime-color-rgb) / 0.06);
  pointer-events: none;
  transition: background 0.5s ease;
  z-index: 0;
}

/* 라이트 모드: 절반 불투명도 (흰 배경에서는 0.06이 너무 진함) */
:root:not(.dark) .regime-loaded .briefing-section::after,
:root:not(.dark) .regime-loaded .mp-ticker-group::after {
  background: rgba(var(--regime-color-rgb) / 0.03);
}

/* reduced-motion: 틴팅 트랜지션만 제거 (틴팅 자체는 유지) */
@media (prefers-reduced-motion: reduce) {
  .regime-loaded .briefing-section::after,
  .regime-loaded .mp-ticker-group::after {
    transition: none !important;
  }
}
```

**주의사항:**
- `.briefing-section`에는 이미 `position: relative`가 있을 수 있으나, 없으면 추가해야 `::after`가 정확히 위치함
- `border-radius: inherit`로 부모의 둥근 모서리를 따름
- `z-index: 0`으로 내부 콘텐츠(z-index: auto 이상) 아래에 위치
- `@media prefers-color-scheme` 사용 금지 — `:root:not(.dark)` 패턴만
  </action>
  <verify>
`ambient-orbs.css`에 다음이 추가되었는지 확인:
- `.regime-loaded .briefing-section::after` 규칙
- `.regime-loaded .mp-ticker-group::after` 규칙
- `:root:not(.dark)` 라이트 모드 분기 (opacity 0.03)
- `@media (prefers-reduced-motion: reduce)` 블록
  </verify>
  <done>regime 틴팅 CSS가 .regime-loaded 조건부로 적용되고, 다크(0.06)/라이트(0.03) 불투명도 분기와 reduced-motion 대응이 포함된다</done>
</task>

<task type="auto">
  <name>Task 2: Add regime signal to home-market-overview.js render()</name>
  <files>static/js/home-market-overview.js</files>
  <action>
`home-market-overview.js`의 `render()` 함수 내부에 2가지를 추가한다.

**WHY:** `home-market-overview.js`가 chart-data를 fetch한 뒤 `render(data)`에서 regime을 알아내고 US-convention 색상(RISK_ON=초록)을 CSS 변수에 설정한다. 그런데 `ambient-orbs.js`는 KR-convention(RISK_ON=빨강)으로 orb 색상을 덮어써야 한다. 만약 polling/hex reverse-lookup으로 regime을 감지하면:
- `fallbackColor.hex`가 리터럴 문자열 `'var(--regime-color)'`여서 hex 비교가 깨지고
- US 색상이 먼저 표시된 뒤 KR 색상으로 바뀌는 flash가 발생한다

**해결:** `render()` 안에서 regime.current 값을 전역으로 노출하고 CustomEvent를 dispatch한다. `ambient-orbs.js`가 이것을 즉시 읽어 KR 색상을 적용하므로 flash 없음.

**변경 위치:** `render()` 함수 내부, `document.documentElement.style.setProperty('--mp-orb-color-secondary', color.rgb);` 줄 바로 다음에 아래 3줄을 추가:

```javascript
    // Expose regime string for ambient-orbs.js KR-convention color mapping
    window.MP_REGIME_CURRENT = (regime && regime.current) || '';
    document.dispatchEvent(new CustomEvent('mp:regime-ready', {
      detail: { regime: window.MP_REGIME_CURRENT }
    }));
```

**기존 코드는 일절 수정하지 않는다.** US-convention `--regime-color`, `--regime-color-rgb`, `--mp-orb-color-*` 설정은 그대로 둔다. `ambient-orbs.js`가 `mp:regime-ready` 이벤트를 받으면 KR-convention 값으로 즉시 덮어쓴다.

**주의사항:**
- `CustomEvent` 생성자는 IE 미지원이지만 이 사이트는 IE를 타겟하지 않으므로 OK
- `render()`는 비동기 fetch 완료 후 호출되므로, `ambient-orbs.js`가 이미 DOM에 로드된 상태에서 이벤트를 받게 된다
  </action>
  <verify>
1. `home-market-overview.js`의 `render()` 함수에 `window.MP_REGIME_CURRENT = ` 할당이 존재
2. `render()` 함수에 `new CustomEvent('mp:regime-ready'` dispatch가 존재
3. 기존 `--regime-color`, `--mp-orb-color-*` 설정 코드가 그대로 유지됨
  </verify>
  <done>home-market-overview.js가 render() 시 window.MP_REGIME_CURRENT를 설정하고 mp:regime-ready 이벤트를 dispatch한다</done>
</task>

<task type="auto">
  <name>Task 3: Add regime detection and KR color mapping to ambient-orbs.js</name>
  <files>static/js/ambient-orbs.js</files>
  <action>
Plan 01에서 생성한 `ambient-orbs.js`의 IIFE 내부에 regime 감지 + 색상 주입 로직을 추가한다.

**한국 컨벤션 색상 매핑 (KR_ORB_RGB):**

Research 결정: mp-config.js의 regime_rgb(미국 컨벤션: RISK_ON=초록)를 직접 수정하지 않고, ambient-orbs.js에 별도 한국 컨벤션 테이블을 둔다. 이렇게 하면 기존 badge/TOC 색상에 영향 없이 orb/tinting만 한국 컨벤션을 따른다.

```javascript
// 한국 시장 컨벤션: 상승=빨강, 하락=파랑, 중립=보라
var KR_ORB_RGB = {
  'RISK_ON':  '220 38 38',   // red-600 (한국: 상승=빨강) → Bull
  'CAUTIOUS': '124 58 237',  // violet-600 (관망) → Neutral
  'RISK_OFF': '37 99 235',   // blue-600 (한국: 하락=파랑) → Bear
  'PANIC':    '37 99 235'    // blue-600 (극단적 하락도 파랑)
};

// 한국 컨벤션 regime tinting 색상 (카드 오버레이용)
var KR_TINT_RGB = {
  'RISK_ON':  '255 51 102',  // 사용자 지정 bull red
  'CAUTIOUS': '124 58 237',  // violet
  'RISK_OFF': '51 136 255',  // 사용자 지정 bear blue
  'PANIC':    '51 136 255'
};
```

**Regime 감지 로직 (polling 제거, 직접 읽기 방식):**

**핵심 변경:** 기존 계획의 hex reverse-lookup polling을 완전히 제거하고, `window.MP_REGIME_CURRENT` 직접 읽기 + `mp:regime-ready` CustomEvent 리스닝으로 교체한다.

**WHY:** `home-market-overview.js`가 US-convention 색상(RISK_ON=초록)을 `--mp-orb-color-*`에 먼저 설정하고, 이후 polling이 그것을 KR-convention으로 덮어쓰면 초록→빨강 flash가 발생한다. 또한 `fallbackColor.hex`가 리터럴 문자열 `'var(--regime-color)'`라서 hex 비교 자체가 깨진다. 직접 읽기 방식이면 regime 문자열을 즉시 얻어 KR 색상을 바로 적용하므로 flash 없음.

**구현 방향:**
1. 즉시 실행: `window.__MP_PAGE?.regime`이 있으면 바로 적용 (포스트 페이지)
2. 홈 페이지: `window.MP_REGIME_CURRENT`가 이미 설정되어 있으면 즉시 적용
3. 아직 설정 안 됐으면: `mp:regime-ready` CustomEvent를 리스닝하여 이벤트 도착 시 적용
4. 안전망: 8초 후에도 regime이 안 오면 중단 (틴팅 없음 = 안전한 기본값)

```javascript
function applyRegime(regimeStr) {
  if (!regimeStr) return;
  var root = document.documentElement;

  // Orb 색상 교체 (한국 컨벤션) — home-market-overview.js가 설정한 US 색상을 즉시 덮어씀
  var orbRgb = KR_ORB_RGB[regimeStr] || '124 58 237';
  root.style.setProperty('--mp-orb-color-primary', orbRgb);
  root.style.setProperty('--mp-orb-color-secondary', orbRgb);

  // Tinting 색상 주입 (카드 오버레이용)
  var tintRgb = KR_TINT_RGB[regimeStr] || '124 58 237';
  root.style.setProperty('--regime-color-rgb', tintRgb);

  // .regime-loaded 클래스 추가 → CSS 틴팅 활성화
  root.classList.add('regime-loaded');
}

// Regime 소스 감지
function detectAndApplyRegime() {
  // 1차: window.__MP_PAGE (포스트 페이지 — Hugo가 인라인으로 주입)
  if (window.__MP_PAGE && window.__MP_PAGE.regime) {
    applyRegime(window.__MP_PAGE.regime);
    return;
  }

  // 2차: window.MP_REGIME_CURRENT (홈 — home-market-overview.js가 render()에서 설정)
  if (window.MP_REGIME_CURRENT) {
    applyRegime(window.MP_REGIME_CURRENT);
    return;
  }

  // 3차: mp:regime-ready 이벤트 리스닝 (home-market-overview.js의 비동기 fetch 완료 대기)
  var applied = false;
  document.addEventListener('mp:regime-ready', function handler(e) {
    if (applied) return;
    applied = true;
    var regime = (e.detail && e.detail.regime) || '';
    applyRegime(regime);
    document.removeEventListener('mp:regime-ready', handler);
  });

  // 안전망: 8초 후에도 이벤트가 안 오면 리스너 정리 (틴팅 없음 = 안전)
  setTimeout(function() {
    if (!applied) {
      applied = true; // 이후 이벤트 무시
    }
  }, 8000);
}

// DOMContentLoaded 후 실행
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', detectAndApplyRegime);
} else {
  detectAndApplyRegime();
}
```

이 로직을 Plan 01에서 생성한 IIFE 내부에 추가한다. 기존 orb DOM 삽입 코드 아래에 배치.

**주의사항:**
- polling/setInterval 사용 금지 — `mp:regime-ready` 이벤트 기반으로 교체됨
- hex reverse-lookup 사용 금지 — `window.MP_REGIME_CURRENT` 문자열을 직접 읽음
- `home-market-overview.js`가 US 색상을 `--mp-orb-color-*`에 먼저 설정하더라도, `mp:regime-ready` 이벤트 핸들러가 동일 `render()` 호출 직후 실행되므로 사실상 동일 프레임에서 KR 색상으로 덮어써져 flash가 인지 불가능
- ES5 호환 유지 (arrow function, template literal 금지)
  </action>
  <verify>
1. `ambient-orbs.js`에 `KR_ORB_RGB` 매핑 테이블이 존재
2. `applyRegime` 함수가 `--mp-orb-color-primary/secondary`, `--regime-color-rgb`를 설정
3. `applyRegime` 함수가 `regime-loaded` 클래스를 `<html>`에 추가
4. `detectAndApplyRegime`가 `window.__MP_PAGE` → `window.MP_REGIME_CURRENT` → `mp:regime-ready` 이벤트 순서로 감지
5. setInterval/polling 코드가 없음 (hex reverse-lookup 없음)
6. ES5 호환 문법 (var, function, no arrow, no template literal)
  </verify>
  <done>regime 상태에 따라 한국 컨벤션 색상이 orb와 카드 틴팅에 적용되고, .regime-loaded 클래스로 CSS 틴팅이 활성화된다. US→KR color flash 없이 동일 프레임에서 KR 색상이 적용된다. 데이터 로드 전에는 틴팅이 표시되지 않는다.</done>
</task>

</tasks>

<verification>
1. Hugo 빌드가 에러 없이 완료된다
2. 홈 페이지에서 regime 데이터가 로드된 후 `.regime-loaded` 클래스가 `<html>`에 추가된다
3. DevTools에서 `.briefing-section::after`의 `background` 값이 현재 regime에 맞는 rgba 색상이다
4. Bull regime → 빨간 기운, Bear regime → 파란 기운, Neutral → 보라 기운이 카드에서 인지된다
5. 다크↔라이트 모드 전환 시 틴팅 불투명도가 변한다 (dark: 0.06, light: 0.03)
6. regime 데이터가 없는 페이지에서 `.regime-loaded` 클래스가 추가되지 않아 틴팅이 나타나지 않는다
7. US→KR color flash가 없다: orb가 초록으로 번쩍였다가 빨강으로 바뀌는 현상이 인지되지 않는다
8. DevTools Console에서 `window.MP_REGIME_CURRENT`를 입력하면 현재 regime 문자열이 반환된다
</verification>

<success_criteria>
- 홈 페이지의 글래스 카드에 regime 기반 색조 틴팅이 적용된다
- 한국 시장 컨벤션(Bull=빨강, Bear=파랑)이 정확히 반영된다
- regime 데이터 로드 전 violet flash가 발생하지 않는다
- US→KR color flash가 발생하지 않는다 (동일 프레임 내 KR 색상 덮어쓰기)
- 다크/라이트 모드 모두에서 틴팅이 적절한 강도로 표시된다
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-regime/03-02-SUMMARY.md`
</output>
