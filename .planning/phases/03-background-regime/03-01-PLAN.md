---
phase: 03-background-regime
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/css/custom/ambient-orbs.css
  - static/js/ambient-orbs.js
  - layouts/partials/extend-head-uncached.html
  - layouts/partials/extend-footer.html
autonomous: true
requirements:
  - BG-01
  - BG-02
  - BG-03

must_haves:
  truths:
    - "페이지 배경에 부드러운 컬러 그라데이션 orb가 보이고, backdrop-filter 카드 뒤에서 블러되어 글래스 효과의 실질적 대상이 된다"
    - "다크 모드에서 orb가 어두운 배경 위에 은은하게 보이고, 라이트 모드에서는 밝은 배경 위에 더 연하게 보인다"
    - "prefers-reduced-motion 설정 시 orb가 표시되되 모든 애니메이션이 정지한다"
    - "모바일(640px 이하)에서 orb 크기와 blur가 축소되어 GPU 부하가 줄어든다"
  artifacts:
    - path: "assets/css/custom/ambient-orbs.css"
      provides: "Fixed orb layer CSS, dark/light mode variants, mobile responsive, reduced-motion"
      contains: "mp-page-orb-layer"
    - path: "static/js/ambient-orbs.js"
      provides: "Orb layer DOM insertion, reduced-motion detection"
      contains: "mp-page-orb-layer"
    - path: "layouts/partials/extend-head-uncached.html"
      provides: "ambient-orbs.css loader registration"
      contains: "ambient-orbs.css"
    - path: "layouts/partials/extend-footer.html"
      provides: "ambient-orbs.js script tag"
      contains: "ambient-orbs.js"
  key_links:
    - from: "static/js/ambient-orbs.js"
      to: "DOM body"
      via: "insertBefore to body.firstChild"
      pattern: "insertBefore.*firstChild"
    - from: "assets/css/custom/ambient-orbs.css"
      to: "--mp-orb-color-primary/secondary CSS vars"
      via: "radial-gradient using var()"
      pattern: "var\\(--mp-orb-color"
---

<objective>
전 페이지 ambient orb 배경 레이어를 구현한다. position: fixed 컨테이너에 3개의 soft gradient orb를 배치해 글래스 카드의 backdrop-filter가 블러할 실질적인 대상을 제공한다.

Purpose: Phase 1-2에서 구축한 글래스 시스템(backdrop-filter)이 단색 배경만 블러하고 있어 시각적 효과가 미미했다. Orb 레이어를 추가하면 블러를 통해 컬러가 확산되어 "프리미엄 글래스" 인상을 만든다.
Output: `ambient-orbs.css` (새 파일), `ambient-orbs.js` (새 파일), 로더 등록 2건
</objective>

<execution_context>
@C:/Users/sc/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/sc/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-background-regime/03-RESEARCH.md

Key reference files:
@assets/css/custom/home-market-overview.css — 기존 .mp-ambient-orb 패턴 참고 (position: absolute, home shell 기준)
@assets/css/custom/toc-and-effects.css — prefers-reduced-motion 패턴 참고
@static/js/home-market-overview.js — 기존 orb DOM 삽입 + 색상 교체 패턴 참고
@layouts/partials/extend-head-uncached.html — CSS 로더 등록 위치
@layouts/partials/extend-footer.html — JS 스크립트 등록 위치
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ambient orb CSS with dark/light mode, mobile, and reduced-motion support</name>
  <files>assets/css/custom/ambient-orbs.css</files>
  <action>
새 파일 `assets/css/custom/ambient-orbs.css`를 생성한다. Research에서 제시한 패턴을 기반으로 구현하되 아래 사양을 정확히 따른다.

**Orb 레이어 컨테이너:**
- `.mp-page-orb-layer`: `position: fixed; inset: 0; pointer-events: none; z-index: 0; overflow: hidden;`
- `body`의 첫 번째 자식으로 삽입될 예정이므로 z-index 0이면 콘텐츠(z-index 1+) 아래에 위치

**Orb 공통:**
- `.mp-page-orb`: `position: absolute; border-radius: 50%; pointer-events: none; will-change: transform, opacity; transition: background 0.5s ease, opacity 0.5s ease;`
- `filter: blur(Npx)` 값은 개별 orb에서 설정

**3개 Orb 배치 (다크 모드 기본):**
1. `.mp-page-orb--primary`: 좌상단(top: -10%, left: -5%), 600x600px, blur(100px), `radial-gradient(circle, rgba(var(--mp-orb-color-primary) / 0.18) 0%, transparent 70%)`, animation: orb-float-primary 18s ease-in-out infinite
2. `.mp-page-orb--secondary`: 우하단(bottom: 10%, right: -8%), 450x450px, blur(80px), `radial-gradient(circle, rgba(var(--mp-orb-color-secondary) / 0.12) 0%, transparent 70%)`, animation: orb-float-secondary 24s ease-in-out infinite, delay -8s
3. `.mp-page-orb--accent`: 중앙(top: 40%, left: 30%), 350x350px, blur(120px), `radial-gradient(circle, rgba(var(--mp-orb-color-primary) / 0.07) 0%, transparent 70%)`, animation: orb-float-accent 30s ease-in-out infinite, delay -15s

**Keyframes (subtle drift, 위치 변화 + 미세 scale):**
- `orb-float-primary`: 0%/100% → translate(0,0) scale(1), 33% → translate(40px,-30px) scale(1.05), 66% → translate(-20px,20px) scale(0.97)
- `orb-float-secondary`: 0%/100% → translate(0,0) scale(1), 40% → translate(-50px,30px) scale(1.08), 70% → translate(30px,-20px) scale(0.95)
- `orb-float-accent`: 0%/100% → translate(0,0), 50% → translate(20px,-40px)

**라이트 모드 (`:root:not(.dark)`):**
- primary opacity를 0.07로 낮춤 (dark: 0.18 → light: 0.07)
- secondary opacity를 0.05로 낮춤 (dark: 0.12 → light: 0.05)
- accent를 `display: none` (라이트에서는 너무 많으면 지저분)

**모바일 (`@media (max-width: 640px)`):**
- primary: 300x300px, blur(60px)
- secondary: 220x220px, blur(50px)
- accent: `display: none`

**prefers-reduced-motion:**
- `.mp-page-orb { animation: none !important; }` — orb는 보이되 움직이지 않음

**주의사항:**
- `@media prefers-color-scheme` 사용 금지 → `.dark` 클래스 기반만 사용 (Prior decision)
- 기존 `.mp-ambient-orb` 클래스명과 겹치지 않도록 `.mp-page-orb` 접두사 사용
- CSS 변수 `--mp-orb-color-primary`, `--mp-orb-color-secondary`는 이미 `custom.css`에 정의되어 있음 (기존 인프라 활용)
  </action>
  <verify>
파일이 생성되었고 다음을 포함하는지 확인:
- `mp-page-orb-layer` 클래스 정의
- `mp-page-orb--primary`, `--secondary`, `--accent` 세 개 orb
- `:root:not(.dark)` 라이트 모드 분기
- `@media (max-width: 640px)` 모바일 분기
- `@media (prefers-reduced-motion: reduce)` 블록
- 3개 `@keyframes` (orb-float-primary, orb-float-secondary, orb-float-accent)
  </verify>
  <done>ambient-orbs.css가 존재하고, 다크/라이트/모바일/reduced-motion 4가지 분기를 모두 포함한다</done>
</task>

<task type="auto">
  <name>Task 2: Create ambient-orbs.js and register both files in Hugo loaders</name>
  <files>
static/js/ambient-orbs.js
layouts/partials/extend-head-uncached.html
layouts/partials/extend-footer.html
  </files>
  <action>
**1. `static/js/ambient-orbs.js` 생성:**

IIFE 패턴으로 구현. 기존 `home-market-overview.js`의 DOM 삽입 패턴 참고.

```javascript
(function() {
  'use strict';

  // 홈 페이지인지 감지 — 홈에는 이미 .mp-ambient-orb가 있으므로 page-level orb 삽입 건너뜀
  // 홈 감지: document.querySelector('.mp-home-shell') 존재 여부
  // 결정: 홈에서도 page-level orb를 삽입한다 (기존 home orb는 shell 내부 absolute, 새 orb는 viewport fixed — 역할 다름)
  // 단, 홈에서 이중 orb가 과하면 Plan 02 실행 후 조정

  // Orb 레이어 DOM 삽입
  var layer = document.createElement('div');
  layer.className = 'mp-page-orb-layer';
  layer.setAttribute('aria-hidden', 'true');
  layer.innerHTML =
    '<div class="mp-page-orb mp-page-orb--primary"></div>' +
    '<div class="mp-page-orb mp-page-orb--secondary"></div>' +
    '<div class="mp-page-orb mp-page-orb--accent"></div>';

  // body 맨 앞에 삽입
  document.body.insertBefore(layer, document.body.firstChild);

  // prefers-reduced-motion 감지: CSS에서도 처리하지만 JS에서도 클래스 추가
  var mql = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)');
  if (mql && mql.matches) {
    layer.classList.add('motion-reduced');
  }
  // 런타임 변경 감지 (사용자가 OS 설정을 바꿀 수 있음)
  if (mql && mql.addEventListener) {
    mql.addEventListener('change', function(e) {
      layer.classList.toggle('motion-reduced', e.matches);
    });
  }
})();
```

위 코드를 기반으로 `static/js/ambient-orbs.js`를 생성한다. ES5 호환 유지.

**2. `extend-head-uncached.html`에 CSS 등록:**

CSS 로드 목록 `range $path := slice "css/custom/briefing-sections.css" ...` 에 `"css/custom/ambient-orbs.css"` 를 추가한다. 위치는 `"css/custom/skeleton.css"` 다음(목록 마지막).

**3. `extend-footer.html`에 JS 등록:**

`<script src="{{ "js/ambient-orbs.js" | relURL }}"></script>` 한 줄을 추가한다. 위치: `mp-config.js` 바로 다음 줄 (orb가 최대한 빨리 삽입되어야 다른 JS보다 먼저 레이어가 존재). theme-transition.js보다는 뒤여도 OK.

**주의사항:**
- `extend-head-uncached.html`은 Hugo 템플릿 — Go template 문법 유지
- `extend-footer.html`의 기존 스크립트 순서를 존중
- `ambient-orbs.js`는 `mp-config.js` 이후에 로드 (MP_CONFIG 접근이 필요할 수 있으므로)
  </action>
  <verify>
1. `static/js/ambient-orbs.js` 파일이 존재하고 `mp-page-orb-layer` DOM 생성 로직을 포함
2. `extend-head-uncached.html`의 CSS slice에 `"css/custom/ambient-orbs.css"` 포함 확인
3. `extend-footer.html`에 `ambient-orbs.js` script 태그 포함 확인
4. `hugo server`로 빌드 시 에러 없음 확인 (가능하면)
  </verify>
  <done>ambient-orbs.js가 body 첫 자식으로 orb 레이어를 삽입하고, CSS/JS가 Hugo 로더에 등록되어 모든 페이지에서 로드된다</done>
</task>

</tasks>

<verification>
1. Hugo 빌드가 에러 없이 완료된다
2. 브라우저에서 페이지 로드 시 `.mp-page-orb-layer` 요소가 `body`의 첫 번째 자식으로 존재한다
3. DevTools Elements에서 3개의 `.mp-page-orb` div가 보인다
4. 다크 모드에서 orb가 은은하지만 인지 가능한 수준으로 보인다
5. 라이트 모드 전환 시 orb 불투명도가 낮아진다
6. DevTools에서 prefers-reduced-motion을 활성화하면 orb 애니메이션이 정지한다
7. 640px 이하 뷰포트에서 orb 크기가 줄어들고 accent orb가 사라진다
</verification>

<success_criteria>
- 모든 페이지(홈, 포스트)에서 position: fixed orb 레이어가 backdrop-filter 카드 뒤에 보인다
- 다크/라이트 모드 전환 시 orb opacity가 적절히 조절된다
- reduced-motion 설정 시 orb가 정적으로 표시된다
- Hugo 빌드 에러 없음
</success_criteria>

<output>
After completion, create `.planning/phases/03-background-regime/03-01-SUMMARY.md`
</output>
