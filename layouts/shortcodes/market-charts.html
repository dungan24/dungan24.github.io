{{ if .Page.Params.chartData }}
{{ if not (.Page.Scratch.Get "chartsRendered") }}
{{ .Page.Scratch.Set "chartsRendered" true }}
<div class="w-full" id="market-charts-root">
  <div class="market-chart-card" id="charts-status-container" data-label="Loading">
    <div class="chart-loading-state" id="charts-loading-ui">
      <div class="chart-spinner"></div>
      <span>Loading market data...</span>
    </div>
  </div>

  <div class="hidden" id="charts-content">
    <div class="market-chart-card" data-label="Trend">
      <h3 class="chart-title-compact">ğŸ“ˆ ì£¼ìš” ì§€í‘œ ì¶”ì´</h3>
      <div class="chart-box" id="chart-timeseries" style="height:350px"></div>
    </div>

    <div class="mp-chart-grid-2col">
      <div class="market-chart-card" data-label="Correlation">
        <h3 class="chart-title-compact">ğŸ”— ìì‚° ê°„ ìƒê´€ê´€ê³„</h3>
        <div class="chart-box" id="chart-correlations" style="height:300px"></div>
      </div>

      <div class="market-chart-card" data-label="Regime">
        <h3 class="chart-title-compact">ğŸ¯ ì‹œì¥ êµ­ë©´ (Regime)</h3>
        <div class="chart-box" id="chart-regime" style="height:300px"></div>
      </div>
    </div>

    <div class="market-chart-card" data-label="Sectors">
      <h3 class="chart-title-compact">ğŸ“Š ì„¹í„° ìƒëŒ€ê°•ë„</h3>
      <div class="chart-box" id="chart-sectors" style="height:300px"></div>
    </div>
  </div>
</div>

<script src="/js/render-charts.js"></script>
<script>
  (function() {
    if (window.__MP_CHARTS_RENDERED) return;
    window.__MP_CHARTS_RENDERED = true;

    var chartDataUrl = '{{ .Page.Params.chartData }}';
    if (!chartDataUrl) return;

    var statusContainer = document.getElementById('charts-status-container');
    var loadingUI = document.getElementById('charts-loading-ui');
    var content = document.getElementById('charts-content');

    function showError(msg) {
      if (statusContainer) statusContainer.dataset.label = 'Error';
      if (loadingUI) {
        loadingUI.innerHTML = '<div style="text-align:center;color:#FF3366">'
          + '<div style="font-weight:700;margin-bottom:0.5rem;font-family:Orbitron,sans-serif;letter-spacing:0.1em">[ DATA_UNAVAILABLE ]</div>'
          + '<div style="font-size:12px;opacity:0.9;font-family:JetBrains Mono,monospace;color:#64748B">' + msg + '</div></div>';
      }
    }

    // 15ì´ˆ íƒ€ì„ì•„ì›ƒ: ë¬´í•œ ë¡œë”© ë°©ì§€
    var timeoutId = setTimeout(function() {
      if (statusContainer && statusContainer.dataset.label === 'Loading') {
        showError('REQUEST TIMEOUT â€” RELOAD TO RETRY');
      }
    }, 15000);

    fetch(chartDataUrl)
      .then(function(r) {
        if (!r.ok) throw new Error('HTTP_' + r.status);
        return r.json();
      })
      .then(function(data) {
        clearTimeout(timeoutId);
        // ë¡œë”© UI ì œê±° â†’ ì°¨íŠ¸ ì»¨í…ì¸  í‘œì‹œ
        if (statusContainer) statusContainer.style.display = 'none';
        if (content) {
          content.classList.remove('hidden');
          void content.offsetHeight;
        }
        renderAllCharts(data);
        if (statusContainer) statusContainer.dataset.label = 'Charts';
      })
      .catch(function(err) {
        clearTimeout(timeoutId);
        console.error('Chart data load failed:', err);
        showError(err.message === 'HTTP_404'
          ? 'MARKET DATA NOT YET PUBLISHED'
          : 'FAILED TO LOAD MARKET DATA');
      });
  })();
</script>
{{ end }}
{{ end }}
