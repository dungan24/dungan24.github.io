<!-- Market Pulse: UI Polish & Intelligence -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  var content = document.querySelector('.article-content') || document.querySelector('.prose');
  if (!content) return;

  var isHomePage = window.location.pathname === '/' || window.location.pathname === '/index.html';

  // === Regime Color Map ===
  var REGIME_COLOR_MAP = {
    'RISK_ON': '#4ade80',
    'CAUTIOUS': '#fbbf24',
    'RISK_OFF': '#f87171',
    'PANIC': '#ef4444',
  };
  var REGIME_COLOR_RGB_MAP = {
    'RISK_ON': '74 222 128',
    'CAUTIOUS': '251 191 36',
    'RISK_OFF': '248 113 113',
    'PANIC': '239 68 68',
  };

  // Mirror of market-pulse KRX holiday table (ssot/tools/market-calendar.ts)
  var KRX_PUBLIC_HOLIDAYS = {
    2024: ['2024-01-01', '2024-02-09', '2024-02-10', '2024-02-12', '2024-03-01', '2024-05-06', '2024-05-15', '2024-06-06', '2024-08-15', '2024-09-16', '2024-09-17', '2024-09-18', '2024-10-03', '2024-10-09', '2024-12-25'],
    2025: ['2025-01-01', '2025-01-28', '2025-01-29', '2025-01-30', '2025-03-01', '2025-05-05', '2025-06-06', '2025-08-15', '2025-10-03', '2025-10-06', '2025-10-07', '2025-10-08', '2025-10-09', '2025-12-25'],
    2026: ['2026-01-01', '2026-02-16', '2026-02-17', '2026-02-18', '2026-03-01', '2026-05-05', '2026-05-24', '2026-06-06', '2026-08-15', '2026-09-24', '2026-09-25', '2026-09-26', '2026-10-03', '2026-10-09', '2026-12-25'],
    2027: ['2027-01-01', '2027-02-06', '2027-02-08', '2027-02-09', '2027-03-01', '2027-05-05', '2027-05-13', '2027-06-06', '2027-08-15', '2027-09-14', '2027-09-15', '2027-09-16', '2027-10-03', '2027-10-09', '2027-12-25'],
    2028: ['2028-01-01', '2028-01-26', '2028-01-27', '2028-01-28', '2028-03-01', '2028-05-02', '2028-05-05', '2028-06-06', '2028-08-15', '2028-10-02', '2028-10-03', '2028-10-04', '2028-10-09', '2028-12-25'],
    2029: ['2029-01-01', '2029-02-12', '2029-02-13', '2029-02-14', '2029-03-01', '2029-05-07', '2029-05-20', '2029-06-06', '2029-08-15', '2029-09-21', '2029-09-22', '2029-09-24', '2029-10-03', '2029-10-09', '2029-12-25'],
    2030: ['2030-01-01', '2030-02-02', '2030-02-04', '2030-02-05', '2030-03-01', '2030-05-06', '2030-05-09', '2030-06-06', '2030-08-15', '2030-09-11', '2030-09-12', '2030-09-13', '2030-10-03', '2030-10-09', '2030-12-25']
  };

  // === Helper: Find briefing-section by H2 text ===
  function findSectionByTitle(titleText) {
    var sections = content.querySelectorAll('.briefing-section');
    for (var i = 0; i < sections.length; i++) {
      var h2 = sections[i].querySelector('h2');
      if (h2 && h2.textContent.includes(titleText)) return sections[i];
    }
    return null;
  }

  // === Zone Detection by Title (Hugo strips HTML comments) ===
  var OPINION_TITLES = [
    '\uD575\uC2EC \uC694\uC57D',     // í•µì‹¬ ìš”ì•½
    '\uC624\uB298\uC758 \uD574\uC11D', // ì˜¤ëŠ˜ì˜ í•´ì„
  ];

  function getZoneByTitle(titleText) {
    for (var i = 0; i < OPINION_TITLES.length; i++) {
      if (titleText.indexOf(OPINION_TITLES[i]) !== -1) return 'opinion';
    }
    return 'fact';
  }

  // 1. Terminal Data Cell Coloring & Formatting
  var cells = content.querySelectorAll('td');
  cells.forEach(function(td) {
    var text = td.textContent.trim();
    if (/^\+\d/.test(text) || /\u2191/.test(text)) td.classList.add('num-up');
    else if (/^-\d/.test(text) || (/\u2193/.test(text) && !/^-$/.test(text))) td.classList.add('num-down');
    if (/\u26A1/.test(text)) td.classList.add('stat-highlight');
    if (/^[+\-]?[\d,]+\.?\d*%?(\s|$)/.test(text) || /^\d[\d,.]*%?$/.test(text)) td.classList.add('num-cell');
  });

  // 2. Table Mobile Responsive Wrapper
  var tables = content.querySelectorAll('table');
  tables.forEach(function(table) {
    if (!table.parentElement.classList.contains('table-wrapper')) {
      var wrapper = document.createElement('div');
      wrapper.className = 'table-wrapper';
      table.parentNode.insertBefore(wrapper, table);
      wrapper.appendChild(table);
    }
  });

  // 3. Dynamic Briefing Section Wrapping (Skip on Home for Hero clarity)
  if (!isHomePage) {
    var h2s = content.querySelectorAll('h2');
    h2s.forEach(function(h2) {
      if (h2.closest('.briefing-section') || h2.classList.contains('hero-subtitle')) return;

      var zone = getZoneByTitle(h2.textContent.trim());
      var section = document.createElement('section');
      section.className = 'briefing-section';
      if (zone === 'opinion') section.classList.add('briefing-section--opinion');
      else section.classList.add('briefing-section--fact');

      h2.parentNode.insertBefore(section, h2);
      section.appendChild(h2);

      var next = section.nextSibling;
      while (next) {
        var current = next;
        next = next.nextSibling;
        if (current.nodeType === 1) {
          var tag = current.tagName;
          if (tag === 'H2' || tag === 'HR' || tag === 'SECTION') break;
        }
        section.appendChild(current);
      }
    });

    // 3b. Opinion H3 Subsection Wrapping
    var opinionSections = content.querySelectorAll('.briefing-section--opinion');
    opinionSections.forEach(function(sec) {
      var h3s = Array.prototype.slice.call(sec.querySelectorAll('h3'));
      if (h3s.length === 0) return;

      h3s.forEach(function(h3) {
        var wrapper = document.createElement('div');
        wrapper.className = 'mp-opinion-sub';
        h3.parentNode.insertBefore(wrapper, h3);
        wrapper.appendChild(h3);

        var next = wrapper.nextSibling;
        while (next) {
          var current = next;
          next = next.nextSibling;
          if (current.nodeType === 1) {
            var tag = current.tagName;
            if (tag === 'H2' || tag === 'H3' || tag === 'SECTION') break;
          }
          wrapper.appendChild(current);
        }
      });
    });

    // === 4. Post Page Enhancements ===

    // 4a. Regime Hero Injection
    if (window.__MP_PAGE && window.__MP_PAGE.regime) {
      var mp = window.__MP_PAGE;
      var regimeColor = REGIME_COLOR_MAP[mp.regime] || '#fbbf24';
      var regimeRgb = REGIME_COLOR_RGB_MAP[mp.regime] || '251 191 36';

      document.documentElement.style.setProperty('--regime-color', regimeColor);
      document.documentElement.style.setProperty('--regime-color-rgb', regimeRgb);

      var articleHeader = document.querySelector('header.mt-12') ||
                          document.querySelector('article header') ||
                          document.querySelector('#single_header');
      if (articleHeader) {
        var hero = document.createElement('div');
        hero.className = 'mp-post-hero';
        hero.style.borderLeftColor = regimeColor;
        hero.innerHTML =
          '<div class="mp-post-hero__top">' +
            '<span class="mp-regime-badge">' + (mp.regimeIcon || '') + ' ' + mp.regime + '</span>' +
          '</div>' +
          (mp.summary ? '<p class="mp-post-hero__summary">' + mp.summary + '</p>' : '');
        articleHeader.after(hero);
      }

      // Hide "í•œì¤„ ìš”ì•½" section (now in hero)
      var summarySection = findSectionByTitle('\uD55C\uC904 \uC694\uC57D');
      if (summarySection) summarySection.style.display = 'none';
    }

    // 4b. Collapsible Sections
    var COLLAPSIBLE_TITLES = [
      '\uCD5C\uADFC \uD750\uB984',       // ìµœê·¼ íë¦„
      '\uC139\uD130 \uC0C1\uB300\uAC15\uB3C4', // ì„¹í„° ìƒëŒ€ê°•ë„
      '\uC774\uBCA4\uD2B8 \uC784\uD329\uD2B8', // ì´ë²¤íŠ¸ ì„íŒ©íŠ¸
      '\uC2DC\uC7A5 \uB3D9\uC870\uD654',   // ì‹œì¥ ë™ì¡°í™”
      '\uC2DC\uC7A5 \uAD6D\uBA74',         // ì‹œì¥ êµ­ë©´
      '\uC6A9\uC5B4 \uC124\uBA85',         // ìš©ì–´ ì„¤ëª…
      '\uCD9C\uCC98',                       // ì¶œì²˜
    ];

    var allSections = content.querySelectorAll('.briefing-section');
    allSections.forEach(function(sec) {
      var h2 = sec.querySelector('h2');
      if (!h2) return;
      var title = h2.textContent.trim();
      var shouldCollapse = COLLAPSIBLE_TITLES.some(function(t) { return title.includes(t); });
      if (!shouldCollapse) return;

      var toggleBtn = document.createElement('button');
      toggleBtn.className = 'mp-collapse-toggle';
      toggleBtn.type = 'button';
      toggleBtn.innerHTML = '<span class="mp-collapse-toggle__icon">\u25B8</span>';

      while (h2.firstChild) toggleBtn.appendChild(h2.firstChild);
      h2.appendChild(toggleBtn);

      var collapsible = document.createElement('div');
      collapsible.className = 'mp-collapsible';

      var sibling = h2.nextSibling;
      while (sibling) {
        var nextSib = sibling.nextSibling;
        collapsible.appendChild(sibling);
        sibling = nextSib;
      }
      sec.appendChild(collapsible);

      // ê¸°ë³¸ í¼ì¹¨ ìƒíƒœ
      collapsible.classList.add('is-open');
      toggleBtn.classList.add('is-open');

      toggleBtn.addEventListener('click', function() {
        var isOpen = collapsible.classList.toggle('is-open');
        toggleBtn.classList.toggle('is-open', isOpen);
        if (isOpen) {
          collapsible.style.maxHeight = collapsible.scrollHeight + 'px';
          setTimeout(function() { collapsible.style.maxHeight = 'none'; }, 350);
        } else {
          collapsible.style.maxHeight = collapsible.scrollHeight + 'px';
          collapsible.offsetHeight;
          collapsible.style.maxHeight = '0';
        }
      });
    });

    // Auto-open collapsible on anchor link
    window.addEventListener('hashchange', function() {
      var target = document.getElementById(window.location.hash.slice(1));
      if (!target) return;
      var coll = target.closest('.mp-collapsible');
      if (coll && !coll.classList.contains('is-open')) {
        var btn = coll.parentElement.querySelector('.mp-collapse-toggle');
        if (btn) btn.click();
        setTimeout(function() { target.scrollIntoView({ behavior: 'smooth' }); }, 400);
      }
    });

    // 4c. News List to Card Grid Transformation
    var newsSection = findSectionByTitle('\uC8FC\uC694 \uB274\uC2A4'); // ì£¼ìš” ë‰´ìŠ¤
    if (newsSection) {
      try {
        var subHeaders = newsSection.querySelectorAll('h3');
        var newsContainer = document.createElement('div');

        subHeaders.forEach(function(h3) {
          var categoryLabel = h3.textContent.trim();
          var ol = h3.nextElementSibling;
          if (!ol || ol.tagName !== 'OL') return;

          var label = document.createElement('div');
          label.className = 'mp-news-section-label';
          label.textContent = categoryLabel;
          newsContainer.appendChild(label);

          var grid = document.createElement('div');
          grid.className = 'mp-news-grid';

          var items = ol.querySelectorAll('li');
          items.forEach(function(li) {
            var card = document.createElement('div');
            card.className = 'mp-news-card';

            var link = li.querySelector('a');
            var strong = li.querySelector('strong');
            var headline = strong ? strong.textContent : (link ? link.textContent : '');
            var href = link ? link.getAttribute('href') : '#';

            // blockquote í…ìŠ¤íŠ¸ë¥¼ ë©”íƒ€ë°ì´í„° íŒŒì‹±ì—ì„œ ì œì™¸
            var blockquote = li.querySelector('blockquote');
            var liClone = li.cloneNode(true);
            var bqClone = liClone.querySelector('blockquote');
            if (bqClone) bqClone.remove();

            var textContent = liClone.textContent || '';
            // ì›ë¬¸: ë¼ì¸ ë¶„ë¦¬ (ê¸€ë¡œë²Œ ë‰´ìŠ¤ ì „ìš©)
            var originalHeadline = '';
            var originalIdx = textContent.indexOf('\uC6D0\uBB38:');
            if (originalIdx !== -1) {
              var afterOriginal = textContent.substring(originalIdx + 3).trim();
              // ì›ë¬¸: ë’¤ì— ì˜¤ëŠ” í…ìŠ¤íŠ¸ì—ì„œ ë©”íƒ€ë¼ì¸(Â·) ì „ê¹Œì§€ê°€ ì›ë¬¸ í—¤ë“œë¼ì¸
              var nextMeta = afterOriginal.search(/[\s\S]*?\u00B7/);
              if (nextMeta === -1) {
                originalHeadline = afterOriginal;
              } else {
                // ì›ë¬¸ í—¤ë“œë¼ì¸ì€ ì¤„ë°”ê¿ˆ ë˜ëŠ” ë©”íƒ€ ì‹œì‘ì ê¹Œì§€
                var lines = afterOriginal.split(/\n/);
                originalHeadline = lines[0].trim();
              }
              textContent = textContent.substring(0, originalIdx);
            }
            var headlineEnd = textContent.indexOf(headline) + headline.length;
            var metaText = textContent.substring(headlineEnd).trim();

            var metaParts = metaText.split('\u00B7').map(function(s) { return s.trim(); });
            var source = metaParts[0] || '';
            var time = metaParts[1] || '';
            var category = metaParts[2] || '';

            var excerpt = blockquote ? blockquote.textContent.trim() : '';

            card.innerHTML =
              (source ? '<div class="mp-news-card__source">' + source + '</div>' : '') +
              '<div class="mp-news-card__headline"><a href="' + href + '" target="_blank" rel="noopener">' + headline + '</a></div>' +
              (originalHeadline ? '<div class="mp-news-card__original"><span class="mp-news-card__en-tag">EN</span>' + originalHeadline + '</div>' : '') +
              '<div class="mp-news-card__meta">' + [time, category].filter(Boolean).join(' \u00B7 ') + '</div>' +
              (excerpt ? '<div class="mp-news-card__excerpt"><span class="mp-news-card__kr-tag">KR</span>' + excerpt + '</div>' : '');

            grid.appendChild(card);
          });

          newsContainer.appendChild(grid);
        });

        if (newsContainer.children.length > 0) {
          var newsH2 = newsSection.querySelector('h2');
          while (newsH2.nextSibling) newsSection.removeChild(newsH2.nextSibling);
          newsSection.appendChild(newsContainer);
        }
      } catch (e) {
        console.warn('News card transformation failed, keeping original:', e);
      }
    }

    // 4c-2. Calendar Timeline Transformation ("ì£¼ìš” ì¼ì •" -> ì›”ë ¥ + ì£¼ìš” ì¼ì • ì¹´ë“œ)
    var calendarSection =
      findSectionByTitle('\uC8FC\uC694 \uC77C\uC815') || // ì£¼ìš” ì¼ì •
      findSectionByTitle('\uC624\uB298\uC758 \uC77C\uC815') || // ì˜¤ëŠ˜ì˜ ì¼ì • (legacy)
      findSectionByTitle('\uC774\uBCA4\uD2B8 \uCE98\uB9B0\uB354'); // ì´ë²¤íŠ¸ ìº˜ë¦°ë”
    if (calendarSection) {
      try {
        convertScheduleToCalendar(calendarSection);
        document.addEventListener('mp:chart-data-ready', function onChartReady() {
          try {
            convertScheduleToCalendar(calendarSection);
          } catch (innerErr) {
            console.warn('Calendar re-render failed after chart data ready:', innerErr);
          }
          document.removeEventListener('mp:chart-data-ready', onChartReady);
        });
      } catch (e) {
        console.warn('Calendar transformation failed, keeping original:', e);
      }
    }

    // 4d. Ticker Card Transformation â€” convert tables in "í•µì‹¬ ìˆ˜ì¹˜" to ticker cards
    var keyDataSection = findSectionByTitle('\uD575\uC2EC \uC218\uCE58'); // í•µì‹¬ ìˆ˜ì¹˜
    if (keyDataSection) {
      try {
        convertTablesToTickerCards(keyDataSection);
      } catch (e) {
        console.warn('Ticker card transformation failed, keeping tables:', e);
      }
    }

    // 4d-2. ì„¹í„° ìƒëŒ€ê°•ë„ í…Œì´ë¸” â†’ í‹°ì»¤ ì¹´ë“œ ë³€í™˜
    // collapsible ë˜í•‘(4b) ì´í›„ì´ë¯€ë¡œ .mp-collapsible ì•ˆìª½ì„ íƒ€ê²Ÿìœ¼ë¡œ ì‚¬ìš©
    var sectorSection = findSectionByTitle('\uC139\uD130 \uC0C1\uB300\uAC15\uB3C4');
    if (sectorSection) {
      try {
        var sectorTarget = sectorSection.querySelector('.mp-collapsible') || sectorSection;
        convertTablesToTickerCards(sectorTarget);
      } catch (e) {
        console.warn('Sector table transformation failed:', e);
      }
    }

    // 4d-3. MD ì›ë³¸ í…Œì´ë¸”ì˜ "íŒë‹¨" ì»¬ëŸ¼ë„ ìƒíƒœ ë°°ì§€ë¡œ í†µì¼
    // (í‹°ì»¤ ì¹´ë“œ ë³€í™˜ ëŒ€ìƒì´ ì•„ë‹Œ ì„¹ì…˜ í¬í•¨)
    try {
      enhanceAssessmentCells(content);
    } catch (e) {
      console.warn('Assessment badge enhancement failed:', e);
    }

    // 4e. TOC ScrollSpy
    initScrollSpy();
  }

  // === Ticker Card Conversion ===
  function parseAssessmentStatus(text, context) {
    if (!text) return null;
    var cleaned = String(text).trim().replace(/^\-\s*/, '');
    var m = cleaned.match(/^(âœ…|âš ï¸?|âŒ|ğŸŸ¢|ğŸŸ¡|ğŸ”´|âšª)\s*(.*)$/);
    if (!m) return null;

    var token = m[1];
    var label = (m[2] || '').trim();
    var tone = 'neutral';

    if (token === 'âœ…' || token === 'ğŸŸ¢') tone = 'ok';
    else if (token === 'âš ' || token === 'âš ï¸' || token === 'ğŸŸ¡') tone = 'warn';
    else if (token === 'âŒ' || token === 'ğŸ”´') tone = 'danger';
    var finalLabel = label || cleaned.replace(/^(âœ…|âš ï¸?|âŒ|ğŸŸ¢|ğŸŸ¡|ğŸ”´|âšª)\s*/, '');

    // ê°œë³„ ì‹ í˜¸ì˜ ì˜ë¯¸ë¥¼ ë°˜ì˜í•´ warn ê³„ì—´ì„ ì„¸ë¶„í™”
    if (tone === 'warn') {
      var metricName = context && context.metricName ? String(context.metricName) : '';
      var valueText = context && context.valueText ? String(context.valueText) : '';
      if (/ì™„í™” ê¸°ëŒ€/.test(finalLabel) || (/US10Y/.test(metricName) && /^-/.test(valueText))) {
        tone = 'info';
      } else if (/íš¡ë³´/.test(finalLabel)) {
        tone = 'neutral';
      } else if (/ê·¹ë‹¨ì  ê³µí¬|contrarian|íƒìš•|ê´´ë¦¬/.test(finalLabel)) {
        tone = 'accent';
      }
    }

    return { tone: tone, label: finalLabel };
  }

  function buildStatusBadge(status) {
    var badge = document.createElement('span');
    badge.className = 'mp-status-badge is-' + status.tone;

    var dot = document.createElement('span');
    dot.className = 'mp-status-dot';
    badge.appendChild(dot);

    var label = document.createElement('span');
    label.className = 'mp-status-label';
    label.textContent = status.label || '-';
    badge.appendChild(label);

    return badge;
  }

  function parseKstDateTime(text) {
    if (!text) return null;
    var normalized = String(text).trim().replace(' ', 'T');
    if (!/T\d{2}:\d{2}(:\d{2})?$/.test(normalized)) return null;
    return new Date(normalized + '+09:00');
  }

  function pad2(v) {
    return String(v).padStart(2, '0');
  }

  function fmtYmd(year, month, day) {
    return String(year) + '-' + pad2(month) + '-' + pad2(day);
  }

  function kstYmd(date) {
    if (!date || isNaN(date.getTime())) return '';
    var p = new Intl.DateTimeFormat('en-CA', {
      timeZone: 'Asia/Seoul',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit'
    }).formatToParts(date).reduce(function(acc, cur) {
      acc[cur.type] = cur.value;
      return acc;
    }, {});
    return p.year + '-' + p.month + '-' + p.day;
  }

  function krxYearEndClosure(year) {
    var d = new Date(Date.UTC(year, 11, 31));
    while (d.getUTCDay() === 0 || d.getUTCDay() === 6) {
      d = new Date(d.getTime() - 86400_000);
    }
    return fmtYmd(d.getUTCFullYear(), d.getUTCMonth() + 1, d.getUTCDate());
  }

  function getKrxHolidaySet(year) {
    var list = KRX_PUBLIC_HOLIDAYS[year] || [];
    var set = new Set(list);
    set.add(krxYearEndClosure(year));
    return set;
  }

  function formatKst(date) {
    if (!date || isNaN(date.getTime())) return '-';
    var p = new Intl.DateTimeFormat('ko-KR', {
      timeZone: 'Asia/Seoul',
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false
    }).formatToParts(date).reduce(function(acc, cur) {
      acc[cur.type] = cur.value;
      return acc;
    }, {});
    return p.year + '-' + p.month + '-' + p.day + ' ' + p.hour + ':' + p.minute + ' KST';
  }

  function getKstNow() {
    return new Date();
  }

  function normalizeImportanceToken(token) {
    var t = String(token || '').trim().toLowerCase();
    if (t === 'ìƒ' || t === 'high') return 'high';
    if (t === 'ì¤‘' || t === 'medium') return 'medium';
    if (t === 'í•˜' || t === 'low') return 'low';
    return 'medium';
  }

  function hasChartKeyEventsPayload() {
    var chartData = window.__MP_CHART_DATA;
    return !!(chartData && Array.isArray(chartData.keyEvents));
  }

  function parseKeyEventsFromChartData() {
    var chartData = window.__MP_CHART_DATA;
    if (!chartData || !Array.isArray(chartData.keyEvents)) return [];
    return chartData.keyEvents.map(function(item) {
      var eventTimeRaw = String(item.eventTimeKst || '').replace(/\s*KST$/, '').trim();
      var eventTime = parseKstDateTime(eventTimeRaw);
      var name = String(item.eventName || '').trim();
      var bracketCountry = (name.match(/^\[([A-Z]{2,5})\]/) || [])[1] || '';
      return {
        country: String(item.country || bracketCountry || 'GLOBAL').trim(),
        name: name,
        nameKo: String(item.eventNameKo || '').trim(),
        dateTime: eventTime,
        importance: normalizeImportanceToken(item.importance),
        previous: String(item.previousValue || '').trim(),
        consensus: String(item.consensus || '').trim(),
        actual: String(item.actualValue || '').trim(),
        status: String(item.status || '').trim(),
        dday: String(item.dday || '').trim(),
        impact: String(item.impactGuide || '').trim(),
        watchAssets: Array.isArray(item.watchAssets) ? item.watchAssets.map(function(v) { return String(v).trim(); }).filter(Boolean) : [],
        isHoliday: /íœ´ì¥|holiday|closed|ê³µíœ´ì¼|ëŒ€ì²´íœ´ì¼/i.test(name),
        raw: name
      };
    }).filter(function(e) {
      return e.name && e.dateTime && !isNaN(e.dateTime.getTime());
    });
  }

  function parseScheduleItem(text) {
    var raw = String(text || '').replace(/\s+/g, ' ').trim();

    // Compact multiline format (mid-day/post-market writer):
    // [ì¤‘][USD][D-6] [USD] Event ì‹œê°: ... KST | ìƒíƒœ: ... ë°ì´í„°: ... ì˜í–¥: ... ì²´í¬: ...
    var compactHead = raw.match(/^\[(ìƒ|ì¤‘|í•˜|high|medium|low)\]\[([^\]]+)\]\[(D(?:[+\-]\d+|ay))\]\s*(?:\[[A-Z]{2,5}\]\s*)?(.+?)\s+ì‹œê°:\s*/i);
    var compactTime = raw.match(/ì‹œê°:\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(?::\d{2})?)\s*KST/i);
    if (compactHead && compactTime) {
      var compactImportance = normalizeImportanceToken(compactHead[1]);
      var compactCountry = compactHead[2].trim();
      var compactName = compactHead[4].trim();
      var compactDateTime = parseKstDateTime(compactTime[1]);
      var compactStatusMatch = raw.match(/ìƒíƒœ:\s*(ì˜ˆì •|ë°œí‘œ|ë§ˆê°)/);
        var compactImpactMatch = raw.match(/ì˜í–¥:\s*(.+?)(?:\s+ì²´í¬:|$)/);
        var compactWatchMatch = raw.match(/ì²´í¬:\s*(.+?)$/);
        var compactDataMatch = raw.match(/ë°ì´í„°:\s*(.+?)(?:\s+ì˜í–¥:|$)/);
        var compactNameKoMatch = raw.match(/ë²ˆì—­:\s*(.+?)(?:\s+ë°ì´í„°:|$)/);
      if (!compactNameKoMatch) {
        compactNameKoMatch = raw.match(/ìƒíƒœ:\s*(?:ì˜ˆì •|ë°œí‘œ|ë§ˆê°)\s+(.+?)\s+ë°ì´í„°:/);
      }
      var compactPrevious = '';
      var compactConsensus = '';
      var compactActual = '';
      if (compactDataMatch) {
        var compactDataText = compactDataMatch[1];
        var compactPrevMatch = compactDataText.match(/ì´ì „\s*([^|]+)/);
        var compactConsMatch = compactDataText.match(/ì˜ˆìƒ\s*([^|]+)/);
        var compactActMatch = compactDataText.match(/ì‹¤ì œ\s*([^|]+)/);
        compactPrevious = compactPrevMatch ? compactPrevMatch[1].trim() : '';
        compactConsensus = compactConsMatch ? compactConsMatch[1].trim() : '';
        compactActual = compactActMatch ? compactActMatch[1].trim() : '';
      }
      return {
        country: compactCountry,
        name: compactName,
        nameKo: compactNameKoMatch ? compactNameKoMatch[1].trim() : '',
        dateTime: compactDateTime,
        importance: compactImportance,
        previous: compactPrevious,
        consensus: compactConsensus,
        actual: compactActual,
        status: compactStatusMatch ? compactStatusMatch[1] : '',
        dday: compactHead[3],
        impact: compactImpactMatch ? compactImpactMatch[1].trim() : '',
        watchAssets: compactWatchMatch ? compactWatchMatch[1].split(',').map(function(v) { return v.trim(); }).filter(Boolean) : [],
        isHoliday: /íœ´ì¥|holiday|closed|ê³µíœ´ì¼|ëŒ€ì²´íœ´ì¼/i.test(compactName),
        raw: raw
      };
    }

    // New key-event multiline format:
    // [ìƒ] [ë¯¸êµ­] [USD] CPI m/m (D-2) | ì‹œê°: ... KST | ìƒíƒœ: ... | ë°ì´í„°: ... | ì˜í–¥: ... | ì²´í¬: ...
    var modernHead = raw.match(/\[(ìƒ|ì¤‘|í•˜|high|medium|low)\]\s*\[([^\]]+)\]\s*(?:\[[A-Z]{2,5}\]\s*)?(.+?)\s*\((D(?:[+\-]\d+|ay))\)/i);
    var modernTime = raw.match(/ì‹œê°:\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(?::\d{2})?)\s*KST/i);
    if (modernHead && modernTime) {
      var modernImportance = normalizeImportanceToken(modernHead[1]);
      var modernCountry = modernHead[2].trim();
      var modernName = modernHead[3].trim();
      var modernDateTime = parseKstDateTime(modernTime[1]);
      var statusMatch = raw.match(/ìƒíƒœ:\s*(ì˜ˆì •|ë°œí‘œ|ë§ˆê°)/);
      var impactMatch = raw.match(/ì˜í–¥:\s*(.+?)(?:\s+ì²´í¬:|$)/);
      var watchMatch = raw.match(/ì²´í¬:\s*(.+?)$/);
      var dataMatch = raw.match(/ë°ì´í„°:\s*(.+?)(?:\s+ì˜í–¥:|$)/);
      var nameKoMatch = raw.match(/ë²ˆì—­:\s*(.+?)(?:\s+ë°ì´í„°:|$)/);
      if (!nameKoMatch) {
        nameKoMatch = raw.match(/ìƒíƒœ:\s*(?:ì˜ˆì •|ë°œí‘œ|ë§ˆê°)\s+(.+?)\s+ë°ì´í„°:/);
      }
      var previous = '';
      var consensus = '';
      var actual = '';
      if (dataMatch) {
        var dataText = dataMatch[1];
        var prevMatch = dataText.match(/ì´ì „\s*([^|]+)/);
        var consMatch = dataText.match(/ì˜ˆìƒ\s*([^|]+)/);
        var actMatch = dataText.match(/ì‹¤ì œ\s*([^|]+)/);
        previous = prevMatch ? prevMatch[1].trim() : '';
        consensus = consMatch ? consMatch[1].trim() : '';
        actual = actMatch ? actMatch[1].trim() : '';
      }

      return {
        country: modernCountry,
        name: modernName,
        nameKo: nameKoMatch ? nameKoMatch[1].trim() : '',
        dateTime: modernDateTime,
        importance: modernImportance,
        previous: previous,
        consensus: consensus,
        actual: actual,
        status: statusMatch ? statusMatch[1] : '',
        dday: modernHead[4],
        impact: impactMatch ? impactMatch[1].trim() : '',
        watchAssets: watchMatch ? watchMatch[1].split(',').map(function(v) { return v.trim(); }).filter(Boolean) : [],
        isHoliday: /íœ´ì¥|holiday|closed|ê³µíœ´ì¼|ëŒ€ì²´íœ´ì¼/i.test(modernName),
        raw: raw
      };
    }

    // Legacy single-line format
    var re = /^\[([A-Z]{2,5})\]\s*(.+?)\s*\|\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}(?::\d{2})?)\s*KST\s*\|\s*ì¤‘ìš”ë„:\s*(high|medium|low)(?:\s*\((.*)\))?$/i;
    var m = raw.match(re);
    if (!m) return null;
    var country = m[1].toUpperCase();
    var name = m[2].trim();
    var dateTime = parseKstDateTime(m[3]);
    var importance = m[4].toLowerCase();
    var extra = (m[5] || '').trim();
    var prev = '';
    var consensus = '';
    var actual = '';
    if (extra) {
      var prevMatch = extra.match(/ì´ì „:\s*([^,\)]+)/);
      var consMatch = extra.match(/ì˜ˆìƒ:\s*([^,\)]+)/);
      var actMatch = extra.match(/ì‹¤ì œ:\s*([^,\)]+)/);
      prev = prevMatch ? prevMatch[1].trim() : '';
      consensus = consMatch ? consMatch[1].trim() : '';
      actual = actMatch ? actMatch[1].trim() : '';
    }
    var holiday = /íœ´ì¥|holiday|closed|ê³µíœ´ì¼|ëŒ€ì²´íœ´ì¼/i.test(name);
    return {
      country: country,
      name: name,
      nameKo: '',
      dateTime: dateTime,
      importance: importance,
      previous: prev,
      consensus: consensus,
      actual: actual,
      status: '',
      dday: '',
      impact: '',
      watchAssets: [],
      isHoliday: holiday,
      raw: raw
    };
  }

  function getEventStatus(event, now) {
    if (event.status === 'ì˜ˆì •' || event.status === 'ë°œí‘œ' || event.status === 'ë§ˆê°') {
      return event.status;
    }
    if (!event.dateTime || isNaN(event.dateTime.getTime())) return 'ì˜ˆì •';
    if (event.actual) return 'ë°œí‘œ';
    return event.dateTime.getTime() <= now.getTime() ? 'ë§ˆê°' : 'ì˜ˆì •';
  }

  function getStatusBadgeClass(status) {
    if (status === 'ë°œí‘œ') return 'released';
    if (status === 'ë§ˆê°') return 'closed';
    return 'scheduled';
  }

  function isKoreanScheduleEvent(event) {
    var country = String(event && event.country ? event.country : '').trim().toUpperCase();
    if (country === 'KR' || country === 'KOR' || country === 'KRW' || country === 'í•œêµ­') return true;
    var raw = String(event && event.raw ? event.raw : '');
    return /^\[(KR|KOR|KRW)\]/i.test(raw) || /\[í•œêµ­\]/.test(raw);
  }

  function selectUpcomingEvents(events, limit) {
    if (!Array.isArray(events) || events.length <= limit) return events || [];
    var selected = events.slice(0, limit);
    var hasKorean = selected.some(function(e) { return isKoreanScheduleEvent(e); });
    if (!hasKorean) {
      var koreanCandidate = events.find(function(e) { return isKoreanScheduleEvent(e); });
      if (koreanCandidate) {
        selected[selected.length - 1] = koreanCandidate;
        selected.sort(function(a, b) {
          return a.dateTime.getTime() - b.dateTime.getTime();
        });
      }
    }
    return selected;
  }

  function normalizeCountryBucket(country) {
    var c = String(country || '').trim().toUpperCase();
    if (c === 'ë¯¸êµ­' || c === 'USD' || c === 'US') return 'us';
    if (c === 'í•œêµ­' || c === 'KR' || c === 'KOR' || c === 'KRW') return 'kr';
    return 'other';
  }

  function getKstDayDiff(eventDate, now) {
    var eventYmd = kstYmd(eventDate || now);
    var nowYmd = kstYmd(now);
    var e = new Date(eventYmd + 'T00:00:00Z');
    var n = new Date(nowYmd + 'T00:00:00Z');
    return Math.round((e.getTime() - n.getTime()) / (24 * 60 * 60 * 1000));
  }

  function matchesUpcomingFilter(event, filterState, now) {
    if (filterState.importance === 'high' && event.importance !== 'high') return false;
    if (filterState.importance === 'high-medium' && event.importance === 'low') return false;
    var periodDiff = getKstDayDiff(event.dateTime, now);
    if (filterState.period === 'pm10' && (periodDiff < -10 || periodDiff > 10)) return false;
    if (filterState.period === 'pm20' && (periodDiff < -20 || periodDiff > 20)) return false;
    if (filterState.period === 'pm30' && (periodDiff < -30 || periodDiff > 30)) return false;
    if (filterState.country !== 'all' && normalizeCountryBucket(event.country) !== filterState.country) return false;
    return true;
  }

  function getMonthAnchor(events, now) {
    if (!events || events.length === 0) return { year: now.getUTCFullYear(), month: now.getUTCMonth() + 1 };
    var valid = events.filter(function(e) { return e.dateTime && !isNaN(e.dateTime.getTime()); });
    if (valid.length === 0) return { year: now.getUTCFullYear(), month: now.getUTCMonth() + 1 };
    var nearest = valid[0];
    var minDiff = Math.abs(nearest.dateTime.getTime() - now.getTime());
    valid.forEach(function(e) {
      var diff = Math.abs(e.dateTime.getTime() - now.getTime());
      if (diff < minDiff) {
        minDiff = diff;
        nearest = e;
      }
    });
    var p = new Intl.DateTimeFormat('en-CA', { timeZone: 'Asia/Seoul', year: 'numeric', month: '2-digit' })
      .formatToParts(nearest.dateTime)
      .reduce(function(acc, cur) { acc[cur.type] = cur.value; return acc; }, {});
    return { year: Number(p.year), month: Number(p.month) };
  }

  function buildCalendarModel(year, month, events, now) {
    var firstWeekday = new Date(Date.UTC(year, month - 1, 1)).getUTCDay(); // 0=Sun
    var daysInMonth = new Date(Date.UTC(year, month, 0)).getUTCDate();
    var prevMonthDays = new Date(Date.UTC(year, month - 1, 0)).getUTCDate();
    var eventMap = {};
    events.forEach(function(e) {
      if (!e.dateTime || isNaN(e.dateTime.getTime())) return;
      var parts = new Intl.DateTimeFormat('en-CA', {
        timeZone: 'Asia/Seoul',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      }).formatToParts(e.dateTime).reduce(function(acc, cur) { acc[cur.type] = cur.value; return acc; }, {});
      var key = parts.year + '-' + parts.month + '-' + parts.day;
      if (!eventMap[key]) eventMap[key] = [];
      eventMap[key].push(e);
    });

    var cells = [];
    for (var i = 0; i < 42; i++) {
      var dayNum = i - firstWeekday + 1;
      var cellYear = year;
      var cellMonth = month;
      var inCurrent = true;
      if (dayNum <= 0) {
        inCurrent = false;
        cellMonth = month - 1;
        if (cellMonth <= 0) { cellMonth = 12; cellYear -= 1; }
        dayNum = prevMonthDays + dayNum;
      } else if (dayNum > daysInMonth) {
        inCurrent = false;
        cellMonth = month + 1;
        if (cellMonth >= 13) { cellMonth = 1; cellYear += 1; }
        dayNum = dayNum - daysInMonth;
      }
      var mm = String(cellMonth).padStart(2, '0');
      var dd = String(dayNum).padStart(2, '0');
      var key = String(cellYear) + '-' + mm + '-' + dd;
      var dayEvents = (eventMap[key] || []).slice().sort(function(a, b) {
        return a.dateTime.getTime() - b.dateTime.getTime();
      });
      var highCount = dayEvents.filter(function(e) { return e.importance === 'high'; }).length;
      var krHolidaySet = getKrxHolidaySet(cellYear);
      var holiday = krHolidaySet.has(key) || dayEvents.some(function(e) { return e.isHoliday; });
      var lines = [];
      if (holiday) lines.push('KR íœ´ì¥');
      dayEvents.forEach(function(e) {
        var st = getEventStatus(e, now);
        lines.push('[' + st + '] ' + formatKst(e.dateTime) + ' Â· [' + e.country + '] ' + e.name + (e.importance ? ' (' + e.importance + ')' : ''));
      });
      var dow = i % 7;
      cells.push({
        key: key,
        day: dayNum,
        dow: dow,
        inCurrent: inCurrent,
        eventCount: dayEvents.length,
        highCount: highCount,
        isHoliday: holiday,
        isToday: key === kstYmd(now),
        tooltipLines: lines
      });
    }
    return cells;
  }

  function convertScheduleToCalendar(section) {
    var hasChartPayload = hasChartKeyEventsPayload();
    var events = parseKeyEventsFromChartData();
    if (!hasChartPayload && events.length === 0) {
      var listItems = section.querySelectorAll('li');
      if (!listItems || listItems.length === 0) return;
      listItems.forEach(function(li) {
        var parsed = parseScheduleItem(li.textContent || '');
        if (parsed) events.push(parsed);
      });
    }
    if (events.length === 0 && !hasChartPayload) return;

    events.sort(function(a, b) {
      var at = a.dateTime ? a.dateTime.getTime() : 0;
      var bt = b.dateTime ? b.dateTime.getTime() : 0;
      return at - bt;
    });

    var now = getKstNow();
    var anchor = getMonthAnchor(events, now);
    var cells = buildCalendarModel(anchor.year, anchor.month, events, now);
    var weekday = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

    var calendar = document.createElement('div');
    calendar.className = 'mp-calendar';
    var title = document.createElement('div');
    title.className = 'mp-calendar__title';
    title.textContent = anchor.year + '-' + String(anchor.month).padStart(2, '0');
    calendar.appendChild(title);

    var grid = document.createElement('div');
    grid.className = 'mp-calendar__grid';

    weekday.forEach(function(w, idx) {
      var head = document.createElement('div');
      head.className = 'mp-calendar__weekday';
      if (idx === 0) head.classList.add('is-sun');
      if (idx === 6) head.classList.add('is-sat');
      head.textContent = w;
      grid.appendChild(head);
    });

    cells.forEach(function(c) {
      var cell = document.createElement('div');
      cell.className = 'mp-calendar__cell';
      if (!c.inCurrent) cell.classList.add('is-outside');
      if (c.dow === 0) cell.classList.add('is-sun');
      if (c.dow === 6) cell.classList.add('is-sat');
      if (c.isHoliday) cell.classList.add('is-holiday');
      if (c.isToday) cell.classList.add('is-today');

      var day = document.createElement('span');
      day.className = 'mp-calendar__day';
      day.textContent = String(c.day);
      cell.appendChild(day);

      if (c.eventCount > 0) {
        var dot = document.createElement('span');
        dot.className = 'mp-calendar__dot';
        if (c.highCount > 0) dot.classList.add('is-high');
        dot.textContent = c.highCount > 0 ? ('H' + c.highCount) : String(c.eventCount);
        cell.appendChild(dot);
      }

      if (c.tooltipLines && c.tooltipLines.length > 0) {
        var tip = document.createElement('div');
        tip.className = 'mp-calendar__tooltip';
        c.tooltipLines.forEach(function(line) {
          var tipLine = document.createElement('div');
          tipLine.className = 'mp-calendar__tooltip-line';
          tipLine.textContent = line;
          tip.appendChild(tipLine);
        });
        cell.appendChild(tip);
      }
      grid.appendChild(cell);
    });
    calendar.appendChild(grid);

    var upcomingWrap = document.createElement('div');
    upcomingWrap.className = 'mp-upcoming';
    var upcomingTitle = document.createElement('div');
    upcomingTitle.className = 'mp-upcoming__title';
    upcomingTitle.textContent = 'ì£¼ìš” ì¼ì • (ìµœê·¼)';
    upcomingWrap.appendChild(upcomingTitle);

    var upcomingList = document.createElement('div');
    upcomingList.className = 'mp-upcoming__list';
    var filterState = {
      importance: 'high',
      period: 'pm10',
      country: 'all'
    };
    var upcomingEvents = events.filter(function(e) {
      return e.dateTime && !isNaN(e.dateTime.getTime());
    });

    var filterBar = document.createElement('div');
    filterBar.className = 'mp-upcoming__filters';

    var importanceSelect = document.createElement('select');
    importanceSelect.className = 'mp-upcoming__filter-select';
    importanceSelect.innerHTML = '<option value="high">ì¤‘ìš”ë„: ìƒ</option><option value="high-medium">ì¤‘ìš”ë„: ìƒ+ì¤‘</option><option value="all">ì¤‘ìš”ë„: ì „ì²´</option>';
    importanceSelect.value = 'high';
    filterBar.appendChild(importanceSelect);

    var periodSelect = document.createElement('select');
    periodSelect.className = 'mp-upcoming__filter-select';
    periodSelect.innerHTML = '<option value="pm10">ê¸°ê°„: -10ì¼~+10ì¼</option><option value="pm20">ê¸°ê°„: -20ì¼~+20ì¼</option><option value="pm30">ê¸°ê°„: -30ì¼~+30ì¼</option><option value="all">ê¸°ê°„: ì „ì²´</option>';
    periodSelect.value = 'pm10';
    filterBar.appendChild(periodSelect);

    var countrySelect = document.createElement('select');
    countrySelect.className = 'mp-upcoming__filter-select';
    countrySelect.innerHTML = '<option value="all">êµ­ê°€: ì „ì²´</option><option value="us">êµ­ê°€: ë¯¸êµ­</option><option value="kr">êµ­ê°€: í•œêµ­</option>';
    filterBar.appendChild(countrySelect);
    upcomingWrap.appendChild(filterBar);

    function renderUpcomingList() {
      upcomingList.innerHTML = '';
      if (upcomingEvents.length === 0) {
        var empty = document.createElement('div');
        empty.className = 'mp-upcoming__empty';
        empty.textContent = 'í‘œì‹œí•  ì£¼ìš” ì¼ì • ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
        upcomingList.appendChild(empty);
        return;
      }

      var filtered = upcomingEvents.filter(function(e) { return matchesUpcomingFilter(e, filterState, now); });
      var visible = selectUpcomingEvents(filtered, 20);
      if (visible.length === 0) {
        var emptyFiltered = document.createElement('div');
        emptyFiltered.className = 'mp-upcoming__empty';
        emptyFiltered.textContent = 'í•„í„° ì¡°ê±´ì— ë§ëŠ” ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ê°„/êµ­ê°€/ì¤‘ìš”ë„ í•„í„°ë¥¼ ì¡°ì •í•´ ë³´ì„¸ìš”.';
        upcomingList.appendChild(emptyFiltered);
        return;
      }

      visible.forEach(function(e) {
        var card = document.createElement('div');
        card.className = 'mp-upcoming__item';

        var head = document.createElement('div');
        head.className = 'mp-upcoming__head';
        var left = document.createElement('span');
        left.className = 'mp-upcoming__event';
        left.textContent = '[' + e.country + '] ' + e.name;
        head.appendChild(left);

        var badges = document.createElement('div');
        badges.className = 'mp-upcoming__badges';

        var imp = document.createElement('span');
        imp.className = 'mp-importance is-' + e.importance;
        imp.textContent = e.importance.toUpperCase();
        badges.appendChild(imp);

        var st = getEventStatus(e, now);
        var statusBadge = document.createElement('span');
        statusBadge.className = 'mp-status-chip is-' + getStatusBadgeClass(st);
        statusBadge.textContent = st;
        badges.appendChild(statusBadge);

        if (e.dday) {
          var ddayBadge = document.createElement('span');
          ddayBadge.className = 'mp-dday-chip';
          ddayBadge.textContent = e.dday;
          badges.appendChild(ddayBadge);
        }

        head.appendChild(badges);

        var meta = document.createElement('div');
        meta.className = 'mp-upcoming__meta';
        var pieces = [formatKst(e.dateTime), 'ìƒíƒœ: ' + st];
        if (e.previous) pieces.push('ì´ì „: ' + e.previous);
        if (e.consensus) pieces.push('ì˜ˆìƒ: ' + e.consensus);
        if (e.actual) pieces.push('ì‹¤ì œ: ' + e.actual);
        meta.textContent = pieces.join('  Â·  ');

        var translation = null;
        if (e.nameKo && e.nameKo !== e.name) {
          translation = document.createElement('div');
          translation.className = 'mp-upcoming__translation';
          translation.textContent = e.nameKo;
        }

        var impact = document.createElement('div');
        impact.className = 'mp-upcoming__impact';
        impact.textContent = e.impact ? ('ì˜í–¥: ' + e.impact) : 'ì˜í–¥: ë°œí‘œ ì „í›„ ê¸ˆë¦¬Â·ë‹¬ëŸ¬Â·ì§€ìˆ˜ì„ ë¬¼ ë°˜ì‘ ì ê²€';

        var watch = document.createElement('div');
        watch.className = 'mp-upcoming__watch';
        var watchText = (e.watchAssets && e.watchAssets.length > 0) ? e.watchAssets.join(', ') : 'ë¯¸êµ­ì±„10ë…„, DXY, ë‚˜ìŠ¤ë‹¥100ì„ ë¬¼';
        watch.textContent = 'ì²´í¬: ' + watchText;

        card.appendChild(head);
        card.appendChild(meta);
        if (translation) card.appendChild(translation);
        card.appendChild(impact);
        card.appendChild(watch);
        upcomingList.appendChild(card);
      });
    }

    importanceSelect.addEventListener('change', function() {
      filterState.importance = importanceSelect.value;
      renderUpcomingList();
    });
    periodSelect.addEventListener('change', function() {
      filterState.period = periodSelect.value;
      renderUpcomingList();
    });
    countrySelect.addEventListener('change', function() {
      filterState.country = countrySelect.value;
      renderUpcomingList();
    });
    renderUpcomingList();
    upcomingWrap.appendChild(upcomingList);

    var h2 = section.querySelector('h2');
    if (!h2) return;
    while (h2.nextSibling) section.removeChild(h2.nextSibling);
    section.appendChild(calendar);
    section.appendChild(upcomingWrap);
  }

  function enhanceAssessmentCells(root) {
    if (!root) return;
    var tables = root.querySelectorAll('table');
    tables.forEach(function(table) {
      var headers = table.querySelectorAll('thead th');
      if (!headers || headers.length === 0) return;

      var assessmentIdx = -1;
      for (var i = 0; i < headers.length; i++) {
        var h = (headers[i].textContent || '').trim();
        if (h === 'íŒë‹¨' || h.indexOf('íŒë‹¨') !== -1) {
          assessmentIdx = i;
          break;
        }
      }
      if (assessmentIdx < 0) return;

      var rows = table.querySelectorAll('tbody tr');
      rows.forEach(function(tr) {
        var cells = tr.querySelectorAll('td');
        if (!cells || cells.length <= assessmentIdx) return;
        var cell = cells[assessmentIdx];
        var raw = (cell.textContent || '').trim();
        var metricName = cells[0] ? (cells[0].textContent || '').trim() : '';
        var valueText = cells[1] ? (cells[1].textContent || '').trim() : '';
        var status = parseAssessmentStatus(raw, { metricName: metricName, valueText: valueText });
        if (!status) return;

        cell.textContent = '';
        cell.classList.add('mp-assessment-cell');
        cell.appendChild(buildStatusBadge(status));
      });
    });
  }

  function convertTablesToTickerCards(section) {
    // Identify groups: H2 direct table = first group, H3 = subsequent groups
    var groups = [];
    var currentGroup = null;
    var children = Array.prototype.slice.call(section.children);

    children.forEach(function(child) {
      if (child.tagName === 'H2') {
        // First group starts with H2 â€” label extracted from H2 text
        currentGroup = { label: '\uBBF8\uAD6D \uC9C0\uC218', tables: [], elements: [] };
        groups.push(currentGroup);
      } else if (child.tagName === 'H3') {
        currentGroup = { label: child.textContent.trim().replace(/\s*âš ï¸.*$/, ''), tables: [], elements: [child] };
        groups.push(currentGroup);
      } else if (child.classList && child.classList.contains('table-wrapper')) {
        var table = child.querySelector('table');
        if (table && currentGroup) {
          currentGroup.tables.push(table);
          currentGroup.elements.push(child);
        }
      } else if (child.tagName === 'TABLE' && currentGroup) {
        currentGroup.tables.push(child);
        currentGroup.elements.push(child);
      } else if (child.tagName === 'BLOCKQUOTE' && currentGroup) {
        // Futures basis blockquote â€” keep it
        currentGroup.elements.push(child);
      }
    });

    if (groups.length === 0) return;

    // Build ticker card container
    var container = document.createElement('div');
    container.className = 'mp-ticker-groups';

    groups.forEach(function(group) {
      if (group.tables.length === 0) return;

      var card = document.createElement('div');
      card.className = 'mp-ticker-group';

      var title = document.createElement('div');
      title.className = 'mp-ticker-group__title';
      title.textContent = group.label;
      card.appendChild(title);

      group.tables.forEach(function(table) {
        var rows = table.querySelectorAll('tbody tr');
        rows.forEach(function(tr) {
          var tds = tr.querySelectorAll('td');
          if (tds.length < 3) return;

          var tickerRow = document.createElement('div');
          tickerRow.className = 'mp-ticker-row';

          var name = document.createElement('span');
          name.className = 'mp-ticker-name';
          name.textContent = tds[0].textContent.trim();

          var price = document.createElement('span');
          price.className = 'mp-ticker-price';
          price.textContent = tds[1].textContent.trim();

          var change = document.createElement('span');
          change.className = 'mp-ticker-change';
          // Use change% (col 3) if available, else change (col 2)
          var changeText = tds.length >= 4 ? tds[3].textContent.trim() : tds[2].textContent.trim();
          var status = parseAssessmentStatus(changeText, { metricName: name.textContent.trim(), valueText: price.textContent.trim() });
          if (status) {
            change.classList.add('is-status');
            change.appendChild(buildStatusBadge(status));
          } else {
            change.textContent = changeText;
            // Color coding
            if (/^\+/.test(changeText) || /\u2191/.test(changeText)) {
              change.classList.add('num-up');
            } else if (/^-/.test(changeText) && changeText !== '-') {
              change.classList.add('num-down');
            }
          }

          tickerRow.appendChild(name);
          tickerRow.appendChild(price);
          tickerRow.appendChild(change);

          // Flow column (col 4) if exists
          var flowSpan = document.createElement('span');
          flowSpan.className = 'mp-ticker-flow';
          if (tds.length >= 5) {
            var rawFlow = tds[4].textContent.trim();
            // "- âš¡ í•˜ìœ„ 9%" í˜•íƒœì˜ leading dashëŠ” ì‹œê°ì ìœ¼ë¡œ ì¤‘ë³µë˜ì–´ ì œê±°
            var flow = rawFlow.replace(/^\-\s*/, '');
            if (flow && flow !== '-') {
              flowSpan.textContent = flow;
              if (/\u2191/.test(flow)) flowSpan.classList.add('num-up');
              else if (/\u2193/.test(flow)) flowSpan.classList.add('num-down');
            } else {
              flowSpan.classList.add('is-empty');
            }
          } else {
            flowSpan.classList.add('is-empty');
          }
          tickerRow.appendChild(flowSpan);

          card.appendChild(tickerRow);
        });
      });

      container.appendChild(card);
    });

    // Remove old tables and H3s
    groups.forEach(function(group) {
      group.elements.forEach(function(el) {
        if (el.parentNode) el.parentNode.removeChild(el);
      });
    });

    // Insert ticker cards: after H2 if present, else prepend to section
    var h2 = section.querySelector('h2');
    if (h2 && h2.nextSibling) {
      h2.parentNode.insertBefore(container, h2.nextSibling);
    } else if (h2) {
      section.appendChild(container);
    } else {
      section.insertBefore(container, section.firstChild);
    }
  }

  // === TOC ScrollSpy ===
  function initScrollSpy() {
    var tocContainer = document.querySelector('.toc');
    if (!tocContainer) return;

    var tocLinks = tocContainer.querySelectorAll('a[href^="#"]');
    if (tocLinks.length === 0) return;

    var observer = new IntersectionObserver(function(entries) {
      entries.forEach(function(entry) {
        if (!entry.isIntersecting) return;
        var id = entry.target.getAttribute('id');
        if (!id) return;

        tocLinks.forEach(function(link) {
          link.classList.remove('is-active');
        });

        var activeLink = tocContainer.querySelector('a[href="#' + id + '"]');
        if (activeLink) activeLink.classList.add('is-active');
      });
    }, {
      rootMargin: '-20% 0px -80% 0px'
    });

    // Observe all H2 elements that have IDs
    var headings = content.querySelectorAll('h2[id]');
    headings.forEach(function(h2) {
      observer.observe(h2);
    });
  }

});
</script>
