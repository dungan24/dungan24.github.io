{{/* Recent Briefings - Categorized cards with distinctive styles */}}
{{ $mp := index .Site.Params "market_pulse" | default .Site.Params.market_pulse }}
{{ $homeCfg := index $mp "home" | default dict }}
{{ $filtersDefault := slice
  (dict "value" "ALL" "label" "ALL")
  (dict "value" "RISK_ON" "label" "RISK ON")
  (dict "value" "CAUTIOUS" "label" "CAUTIOUS")
  (dict "value" "RISK_OFF" "label" "RISK OFF")
  (dict "value" "PANIC" "label" "PANIC")
}}
{{ $filters := index $homeCfg "regime_filters" | default $filtersDefault }}
{{ $regimeCfg := index $mp "regime" | default dict }}
{{ $defaultRegime := index $regimeCfg "default_status" | default "CAUTIOUS" }}
<h3 class="mp-section-header">Recent Briefings</h3>
<div class="mp-regime-filter-wrap" id="mp-regime-filter-wrap">
  <p class="mp-regime-filter-label">Market Regime Filter</p>
  <div class="mp-regime-filter" id="mp-regime-filter" role="tablist" aria-label="Filter briefings by market regime">
    {{ range $idx, $f := $filters }}
      {{ $value := index $f "value" | default "ALL" }}
      {{ $label := index $f "label" | default $value }}
      <button class="mp-filter-chip{{ if eq $idx 0 }} is-active{{ end }}" data-filter="{{ $value }}">{{ $label }}</button>
    {{ end }}
  </div>
  <p class="mp-regime-filter-note" id="mp-regime-filter-note" hidden>Filters activate automatically once multiple regimes are available.</p>
</div>
<div class="mp-briefing-cards" id="mp-briefing-cards-container">
{{ $pages := first 6 (where .Site.RegularPages "Section" "posts") }}
{{ $grouped := $pages.GroupByDate "2006-01-02" }}
{{ range $grouped }}
  {{ $date := .Key }}
  {{ $displayDate := (time $date).Format "01.02 (Mon)" }}
  
  <div class="mp-date-group" data-date="{{ $date }}">
    <div class="mp-date-label">{{ $displayDate }}</div>
    {{ range .Pages }}
      {{ $regime := .Params.regime | default $defaultRegime }}
      {{ $regime = upper $regime }}
      {{ $regimeIcon := .Params.regimeIcon }}
      {{ if not $regimeIcon }}
        {{ if eq $regime "RISK_ON" }}{{ $regimeIcon = "ğŸŸ¢" }}{{ end }}
        {{ if eq $regime "CAUTIOUS" }}{{ $regimeIcon = "ğŸŸ¡" }}{{ end }}
        {{ if eq $regime "RISK_OFF" }}{{ $regimeIcon = "ğŸ”´" }}{{ end }}
        {{ if eq $regime "PANIC" }}{{ $regimeIcon = "ğŸš¨" }}{{ end }}
      {{ end }}
      {{ if not $regimeIcon }}{{ $regimeIcon = "âšª" }}{{ end }}

      {{/* Summary ì¶”ì¶œ: front matter â†’ blockquote â†’ .Plain ìˆœ */}}
      {{ $summary := .Params.summary | default .Description }}
      {{ if not $summary }}
        {{/* Priority Insight: ì²« ë²ˆì§¸ blockquote(> **...**) í…ìŠ¤íŠ¸ ì¶”ì¶œ */}}
        {{ $bqMatch := findRE `\n> \*{0,2}[^\n\r]{5,}` .RawContent 1 }}
        {{ if $bqMatch }}
          {{ $bq := index $bqMatch 0 }}
          {{ $bq = replaceRE `[\n\r]*>\s*` "" $bq }}
          {{ $bq = replaceRE `\*{1,2}` "" $bq }}
          {{ $bq = trim $bq " \t\r\n" }}
          {{ if $bq }}{{ $summary = truncate 140 $bq }}{{ end }}
        {{ end }}
      {{ end }}
      {{ if not $summary }}
        {{ $plain := .Plain | replaceRE `\s+` " " }}
        {{ $plain = trim $plain " " }}
        {{ if $plain }}{{ $summary = truncate 140 $plain }}{{ end }}
      {{ end }}
      {{ if not $summary }}{{ $summary = "í•µì‹¬ ë°ì´í„°ì™€ ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ë‹´ì€ ë¸Œë¦¬í•‘ì…ë‹ˆë‹¤. ë³¸ë¬¸ì—ì„œ ìì„¸íˆ í™•ì¸í•˜ì„¸ìš”." }}{{ end }}

      {{/* Detect Briefing Type */}}
      {{ $type := "default" }}
      {{ $typeIcon := "" }}
      {{ if in .File.BaseFileName "pre-market" }}
        {{ $type = "pre" }}
        {{ $typeIcon = "ğŸŒ…" }}
      {{ end }}
      {{ if in .File.BaseFileName "mid-day" }}
        {{ $type = "mid" }}
        {{ $typeIcon = "â˜€ï¸" }}
      {{ end }}
      {{ if in .File.BaseFileName "post-market" }}
        {{ $type = "post" }}
        {{ $typeIcon = "ğŸŒ™" }}
      {{ end }}

      {{ $rawTime := .Date.Format "15:04" }}
      {{ $timeLabel := $rawTime }}
      {{ if eq $rawTime "00:00" }}
        {{ if eq $type "pre" }}{{ $timeLabel = "PRE" }}{{ end }}
        {{ if eq $type "mid" }}{{ $timeLabel = "MID" }}{{ end }}
        {{ if eq $type "post" }}{{ $timeLabel = "POST" }}{{ end }}
        {{ if eq $type "default" }}{{ $timeLabel = "DAILY" }}{{ end }}
      {{ end }}
      {{ $timeClass := "" }}
      {{ if ne $timeLabel $rawTime }}{{ $timeClass = "is-slot" }}{{ end }}

      {{ $isToday := false }}
      {{ $nowKST := now.UTC.Add (duration "hour" 9) }}
      {{ $postKST := .Date.UTC.Add (duration "hour" 9) }}
      {{ if eq ($nowKST.Format "2006-01-02") ($postKST.Format "2006-01-02") }}
        {{ $isToday = true }}
      {{ end }}

      <a href="{{ .RelPermalink }}" class="mp-briefing-card mp-card--{{ $type }}" data-regime="{{ $regime }}">
        <div class="mp-briefing-card__type-tag">
          {{ $typeIcon }} {{ upper $type }}
          {{ if $isToday }}<span class="mp-new-badge">NEW</span>{{ end }}
        </div>
        <div class="mp-briefing-card__header">
          <span class="mp-briefing-card__title">{{ .Title }}</span>
          <time class="{{ $timeClass }}" datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}" title="{{ .Date.Format "2006-01-02" }} KST">{{ $timeLabel }}</time>
        </div>
        <p class="mp-briefing-card__summary">{{ $summary }}</p>
        <div class="mp-briefing-card__footer">
          <span class="mp-briefing-card__regime">{{ $regimeIcon }} {{ $regime }}</span>
          {{ with .Params.tags }}
          <div class="mp-briefing-card__tags">
            {{ range first 2 . }}<span class="mp-briefing-card__tag">#{{ . }}</span>{{ end }}
          </div>
          {{ end }}
        </div>
      </a>
    {{ end }}
  </div>
{{ end }}
</div>

