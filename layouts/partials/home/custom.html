{{/* Market Pulse Homepage — Hero + Tickers + Briefings */}}
<div class="mp-home-shell" style="max-width:72rem;margin:0 auto;padding:2rem 1rem 4rem;position:relative;overflow:hidden">
  <div class="mp-ambient-orbs">
    <div style="position:absolute;top:-10%;left:-5%;width:500px;height:500px;border-radius:50%;background:radial-gradient(circle,rgba(124,58,237,0.2),transparent 70%);filter:blur(60px);pointer-events:none" class="animate-pulse-slow"></div>
    <div style="position:absolute;top:40%;right:-10%;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(0,240,255,0.12),transparent 70%);filter:blur(60px);pointer-events:none" class="animate-pulse-slower"></div>
  </div>
  <!-- HUD Corner Decorations -->
  <div class="mp-hud-corners">
    <div class="mp-hud-corner mp-hud-corner--tl"></div>
    <div class="mp-hud-corner mp-hud-corner--tr"></div>
    <div class="mp-hud-corner mp-hud-corner--bl"></div>
    <div class="mp-hud-corner mp-hud-corner--br"></div>
    <span class="mp-hud-status">SYS:ONLINE</span>
  </div>
  <div class="mp-home-content" style="position:relative;z-index:1">

  <!-- Hero -->
  <div style="text-align:center">
    <div class="mp-hero-title-row">
      <svg class="mp-ecg-pulse mp-ecg-pulse--left" viewBox="0 0 200 40" fill="none">
        <defs>
          <filter id="ecg-glow" x="-20%" y="-80%" width="140%" height="260%">
            <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur1"/>
            <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur2"/>
            <feMerge>
              <feMergeNode in="blur2"/>
              <feMergeNode in="blur1"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        <path class="mp-ecg-line" filter="url(#ecg-glow)"
              d="M 0,20 L 55,20 L 62,16 L 70,20 L 78,20 L 82,23 L 86,3 L 90,37 L 94,20 L 106,20 L 114,13 L 122,20 L 200,20"
              stroke="#00F0FF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
      </svg>

      <h1 class="mp-heartbeat-title">
        <span class="mp-heartbeat">Market Pulse</span>
      </h1>

      <svg class="mp-ecg-pulse mp-ecg-pulse--right" viewBox="0 0 200 40" fill="none">
        <use href="#ecg-glow"/>
        <path class="mp-ecg-line mp-ecg-line--right" filter="url(#ecg-glow)"
              d="M 0,20 L 78,20 L 86,13 L 94,20 L 106,20 L 110,23 L 114,3 L 118,37 L 122,20 L 138,20 L 145,16 L 150,20 L 200,20"
              stroke="#00F0FF" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
      </svg>
    </div>

    <p class="mp-subtitle-flicker" style="font-family:'JetBrains Mono',monospace;font-size:0.75rem;color:#00F0FF;letter-spacing:0.15em;margin:0.5rem 0 1.5rem;text-transform:uppercase;text-shadow:0 0 8px rgba(0,240,255,0.3)">
      // FACT-DRIVEN MARKET INTELLIGENCE
    </p>

    <div id="mp-regime-badge" class="mp-regime-badge">--</div>
    <p id="mp-hero-summary" class="mp-hero-summary">Loading...</p>
    <p id="mp-hero-updated" class="mp-hero-updated"></p>
  </div>

  <!-- Ticker Groups -->
  <h3 class="mp-section-header">Market Overview</h3>
  <div id="mp-ticker-groups" class="mp-ticker-groups">
    <span style="opacity:0.4;grid-column:1/-1;text-align:center;padding:2rem;font-size:0.85rem">Loading market data...</span>
  </div>
  <p id="mp-data-timestamp" class="mp-hero-updated" style="text-align:right;margin-top:0.5rem"></p>

  <!-- Recent Briefings -->
  {{ partial "home/recent-briefings.html" . }}

  <!-- More -->
  <div style="text-align:center;margin-top:2rem">
    <a href="/posts/" class="mp-more-link">
      전체 브리핑 보기 →
    </a>
  </div>
</div>
</div>

<style>
/* ECG pulse draw animation */
.mp-ecg-line {
  stroke-dasharray: 269;
  stroke-dashoffset: 269;
  animation: ecg-draw 3.5s ease-in-out infinite;
}

.mp-ecg-line--right {
  animation-delay: 0.3s;
}

@keyframes ecg-draw {
  0%   { stroke-dashoffset: 269; opacity: 0; }
  8%   { opacity: 0.85; }
  50%  { stroke-dashoffset: 0; opacity: 0.85; }
  70%  { stroke-dashoffset: 0; opacity: 0.5; }
  90%  { stroke-dashoffset: 0; opacity: 0; }
  100% { stroke-dashoffset: 269; opacity: 0; }
}
</style>

<script>
(function() {
  'use strict';

  // ── Regime colors ──
  var REGIME_COLORS = {
    'RISK_ON':  { hex: '#00FF88', rgb: '0 255 136' },
    'CAUTIOUS': { hex: '#FFD600', rgb: '255 214 0' },
    'RISK_OFF': { hex: '#FF3366', rgb: '255 51 102' },
    'PANIC':    { hex: '#FF0040', rgb: '255 0 64' }
  };

  // ── Ticker group definitions ──
  var GROUPS = [
    { title: 'US INDICES', tickers: [
      { key: 'SPX', name: 'S&P 500', fmt: 'index' },
      { key: 'NDX', name: 'Nasdaq', fmt: 'index' },
      { key: 'DJI', name: 'Dow Jones', fmt: 'index' }
    ]},
    { title: 'RISK METRICS', tickers: [
      { key: 'VIX', name: 'VIX', fmt: 'decimal', invertColor: true },
      { key: 'US10Y', name: 'US 10Y Bond', fmt: 'decimal' },
      { key: 'USDKRW', name: 'USD/KRW', fmt: 'decimal' }
    ]},
    { title: 'ALTERNATIVES', tickers: [
      { key: 'BTC', name: 'Bitcoin', fmt: 'dollar' },
      { key: 'GOLD', name: 'Gold', fmt: 'dollar' },
      { key: 'OIL', name: 'WTI Oil', fmt: 'dollar' }
    ]}
  ];

  // ── Format helpers ──
  function fmtPrice(val, fmt) {
    if (fmt === 'index') return val.toLocaleString('en-US', { maximumFractionDigits: 0 });
    if (fmt === 'dollar') return val.toLocaleString('en-US', { maximumFractionDigits: val >= 1000 ? 0 : 2 });
    return val.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  function fmtChange(pct) {
    var sign = pct >= 0 ? '+' : '';
    return sign + pct.toFixed(2) + '%';
  }

  // ── Sparkline SVG (pure, no CDN) ──
  function generateSparkline(data, color) {
    if (!data || data.length < 2) return '';
    var pts = data.slice(-15);
    var min = Math.min.apply(null, pts);
    var max = Math.max.apply(null, pts);
    var range = max - min || 1;
    var w = 60, h = 20, pad = 2;

    var coords = [];
    for (var i = 0; i < pts.length; i++) {
      var x = (i / (pts.length - 1)) * w;
      var y = pad + ((max - pts[i]) / range) * (h - pad * 2);
      coords.push(x.toFixed(1) + ',' + y.toFixed(1));
    }

    return '<svg class="mp-sparkline" viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="none">' +
      '<polyline points="' + coords.join(' ') + '" fill="none" stroke="' + color +
      '" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
  }

  // ── Render ticker groups ──
  function renderTickerGroups(ts) {
    var container = document.getElementById('mp-ticker-groups');
    if (!container || !ts || !ts.series) return;

    var html = '';

    for (var g = 0; g < GROUPS.length; g++) {
      var group = GROUPS[g];
      var rows = '';
      var hasData = false;

      for (var t = 0; t < group.tickers.length; t++) {
        var ticker = group.tickers[t];
        var s = ts.series[ticker.key];
        if (!s || s.length < 2) continue;

        hasData = true;
        var current = s[s.length - 1];
        var prev = s[s.length - 2];
        var changePct = ((current - prev) / prev) * 100;

        var isPositive = ticker.invertColor ? changePct < 0 : changePct >= 0;
        var changeColor = changePct === 0 ? 'rgb(var(--color-neutral-400))'
          : isPositive ? '#00FF88' : '#FF3366';
        var sparkColor = changePct === 0 ? '#64748B' : isPositive ? '#00FF88' : '#FF3366';

        rows += '<div class="mp-ticker-row">' +
          '<span class="mp-ticker-name">' + ticker.name + '</span>' +
          '<span class="mp-ticker-price">' + fmtPrice(current, ticker.fmt) + '</span>' +
          '<span class="mp-ticker-change" style="color:' + changeColor + '">' + fmtChange(changePct) + '</span>' +
          generateSparkline(s, sparkColor) +
          '</div>';
      }

      if (!hasData) continue;

      html += '<div class="mp-ticker-group">' +
        '<div class="mp-ticker-group__title">' + group.title + '</div>' +
        rows + '</div>';
    }

    container.innerHTML = html ||
      '<span style="opacity:0.4;grid-column:1/-1;text-align:center;padding:2rem">' +
      '\uB370\uC774\uD130\uB97C \uBD88\uB7EC\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4</span>';
  }

  // ── Main render ──
  function render(data) {
    if (!data) return;

    var regime = data.regime;
    var color = REGIME_COLORS[regime && regime.current] || REGIME_COLORS['CAUTIOUS'];

    // 1. Set CSS variables
    document.documentElement.style.setProperty('--regime-color', color.hex);
    document.documentElement.style.setProperty('--regime-color-rgb', color.rgb);

    // 2. Regime badge
    var badge = document.getElementById('mp-regime-badge');
    if (badge && regime) {
      badge.textContent = (regime.icon || '\uD83D\uDFE1') + ' ' + (regime.label || regime.current);
    }

    // 3. Hero summary
    var summary = document.getElementById('mp-hero-summary');
    if (summary && regime && regime.summary) {
      summary.textContent = regime.summary;
    }

    // 4. Updated time
    var updated = document.getElementById('mp-hero-updated');
    if (updated && data.date) {
      updated.textContent = '\uAE30\uC900: ' + data.date;
    }

    // 5. Ticker groups
    if (data.timeSeries) {
      renderTickerGroups(data.timeSeries);
    }

    // 7. Data timestamp
    var ts = document.getElementById('mp-data-timestamp');
    if (ts && data.date) {
      ts.textContent = '\uB370\uC774\uD130 \uAE30\uC900: ' + data.date;
    }
  }

  // ── Data fetch (today → yesterday fallback) ──
  function fetchData() {
    var today = new Date();
    var fmt = function(d) { return d.toISOString().split('T')[0]; };
    var urls = [
      '/data/chart-data-' + fmt(today) + '.json',
      '/data/chart-data-' + fmt(new Date(today.getTime() - 86400000)) + '.json'
    ];
    tryFetch(urls, 0);
  }

  function tryFetch(urls, idx) {
    if (idx >= urls.length) {
      var el = document.getElementById('mp-hero-summary');
      if (el) el.textContent = 'Data unavailable';
      var tg = document.getElementById('mp-ticker-groups');
      if (tg) tg.innerHTML = '<span style="opacity:0.4;grid-column:1/-1;text-align:center;padding:2rem">' +
        '\uB370\uC774\uD130\uB97C \uBD88\uB7EC\uC62C \uC218 \uC5C6\uC2B5\uB2C8\uB2E4</span>';
      return;
    }

    fetch(urls[idx])
      .then(function(r) { if (!r.ok) throw new Error(r.status); return r.json(); })
      .then(function(data) { render(data); })
      .catch(function() { tryFetch(urls, idx + 1); });
  }

  // ── Init ──
  fetchData();
})();
</script>
